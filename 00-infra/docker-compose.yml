services:
  # 1. Certificate Manager (Wildcard)
  acme:
    env_file: ../.env
    image: ${ACME_IMAGE:-neilpang/acme.sh:latest}
    container_name: acme.sh
    restart: unless-stopped
    command: daemon
    volumes:
      - ${DOCKER_ROOT:-/nfs/docker}/global/certs:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:-dummy_token}
      - CF_Account_ID=${CLOUDFLARE_ACCOUNT_ID:-dummy_id}
    network_mode: host

  # 2. Ingress Tunnel (Public Access)
  cloudflared:
    env_file: ../.env
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token ${CF_TOKEN:-dummy_token}
    networks:
      - vps-net

  # 3. Auto-Updater
  watchtower:
    env_file: ../.env
    image: hub.rat.dev/containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_SCHEDULE=0 0 4 * * *  # 4 AM Daily
      - DOCKER_API_VERSION=1.44
      # Notifications via PushPlus (Shoutrrr format)
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

  # 4. Mandatory Cert Generator (First-run automation)
  acme-init:
    env_file: ../.env
    image: ${ACME_IMAGE:-neilpang/acme.sh:latest}
    container_name: acme-init
    depends_on:
      - acme
    volumes:
      - ${DOCKER_ROOT:-/nfs/docker}/global/certs:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:-dummy_token}
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
    network_mode: host
    command: |
      /bin/sh -c "
      sleep 10;
      if [ ! -s /acme.sh/\${DERP_DOMAIN}/\${DERP_DOMAIN}.crt ] || ! grep -q 'BEGIN CERTIFICATE' /acme.sh/\${DERP_DOMAIN}/\${DERP_DOMAIN}.crt; then
        echo 'ðŸš€ Issuing/Repairing certificate for \${DERP_DOMAIN}...'
        rm -rf /acme.sh/\${DERP_DOMAIN}/*
        /entry.sh --issue --server letsencrypt -d \${DERP_DOMAIN} --dns dns_cf --keylength ec-256
        /entry.sh --install-cert -d \${DERP_DOMAIN} --ecc --cert-file /acme.sh/\${DERP_DOMAIN}/\${DERP_DOMAIN}.crt --key-file /acme.sh/\${DERP_DOMAIN}/\${DERP_DOMAIN}.key
      else
        echo 'âœ… Valid certificate for \${DERP_DOMAIN} exists. Skipping.'
      fi
      "

networks:
  vps-net:
    external: true
