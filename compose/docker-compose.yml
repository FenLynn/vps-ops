
# =============================================================================
# VPS-OPS v2.0 â€” ç»Ÿä¸€æœåŠ¡ç¼–æ’æ–‡ä»¶
# æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€æ–‡ä»¶ä¸­ç®¡ç†ï¼Œé€šè¿‡ depends_on æ§åˆ¶å¯åŠ¨é¡ºåº
# é›¶ç«¯å£æš´éœ²æ¶æ„ï¼šé™¤ DERP å¤–ï¼Œæ‰€æœ‰æµé‡èµ° Cloudflare Tunnel
# =============================================================================

# â”€â”€â”€ å…¨å±€å˜é‡çº¦å®š â”€â”€â”€
# BASE_DIR      = /opt/vps-dmz          (å®¿ä¸»æœºæ ¹ç›®å½•)
# MAIN_DOMAIN   = 660415.xyz            (ä¸»åŸŸå)
# DERP_DOMAIN   = derp.660415.xyz       (DERP èŠ‚ç‚¹åŸŸå)
# ACME_STAGING  = true | false
#   true  â†’ ä½¿ç”¨ Let's Encrypt æµ‹è¯•æœåŠ¡å™¨ (æ— é™æ¬¡æ•°ï¼Œè¯ä¹¦ä¸å—ä¿¡ä»»ï¼Œç”¨äºè°ƒè¯•)
#   false â†’ ä½¿ç”¨ Let's Encrypt ç”Ÿäº§æœåŠ¡å™¨ (æ­£å¼è¯ä¹¦ï¼Œæ¯åŸŸåæ¯å‘¨é™5æ¬¡)

services:

  # =========================================================================
  # Layer 0: åŸºç¡€è®¾æ–½ (Infrastructure)
  # =========================================================================

  # --- Cloudflare Tunnel (å®‰å…¨å…¥å£) ---
  cloudflared:
    image: ghcr.io/fenlynn/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token ${CF_TOKEN:?CF_TOKEN is required}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    healthcheck:
      # cloudflared é€šè¿‡å‘½ä»¤è¡Œ token è¿è¡Œï¼Œtunnel info éœ€è¦å‡­è¯æ–‡ä»¶æ— æ³•ä½¿ç”¨
      # æ”¹ä¸ºæ£€æŸ¥ metrics server (20241 ç«¯å£) åˆ¤æ–­è¿›ç¨‹æ˜¯å¦å¥åº·
      test: ["CMD-SHELL", "wget -qO /dev/null http://localhost:20241/metrics 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # --- è¯ä¹¦ç®¡ç† (acme.sh daemon å¸¸é©») ---
  acme:
    image: ghcr.io/fenlynn/acme.sh:latest
    container_name: acme
    restart: unless-stopped
    command: daemon
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:?CF_DNS_API_TOKEN is required}
      - CF_Account_ID=${CLOUDFLARE_ACCOUNT_ID:-}
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    network_mode: host

  # --- é¦–æ¬¡è¯ä¹¦ç­¾å‘ (ä¸€æ¬¡æ€§ä»»åŠ¡) ---
  acme-init:
    image: ghcr.io/fenlynn/acme.sh:latest
    container_name: acme-init
    depends_on:
      - acme
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:?CF_DNS_API_TOKEN is required}
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      # âš™ï¸ æµ‹è¯•æ¨¡å¼å¼€å…³
      # ACME_STAGING=true  â†’ ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨(æ— é™æ¬¡ï¼Œè¯ä¹¦ä¸å—ä¿¡ä»»)
      # ACME_STAGING=false â†’ ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨(æ­£å¼è¯ä¹¦ï¼Œæœ‰é€Ÿç‡é™åˆ¶)
      - ACME_STAGING=${ACME_STAGING:-false}
    network_mode: host
    restart: "no"
    command: |
      /bin/sh -c "
      # æ ¹æ® ACME_STAGING é€‰æ‹© CA æœåŠ¡å™¨
      if [ \"$$ACME_STAGING\" = \"true\" ]; then
        ACME_SERVER=letsencrypt_test;
        echo 'âš ï¸  [STAGING MODE] ä½¿ç”¨ Let'\''s Encrypt æµ‹è¯•æœåŠ¡å™¨ - è¯ä¹¦ä¸å—æµè§ˆå™¨ä¿¡ä»»!';
      else
        ACME_SERVER=letsencrypt;
        echo 'ğŸ”’ [PROD MODE] ä½¿ç”¨ Let'\''s Encrypt ç”Ÿäº§æœåŠ¡å™¨';
      fi;

      # â³ ç­‰å¾… acme daemon å®Œå…¨å°±ç»ª (30s)
      # ç”Ÿäº§ç¯å¢ƒ DNS ä¼ æ’­ + CF API æˆæƒéœ€è¦å……è¶³æ—¶é—´ï¼Œ5s è¿œè¿œä¸å¤Ÿ
      echo 'â³ ç­‰å¾… acme daemon å°±ç»ª (30s)...';
      sleep 30;

      CERT_FILE=/acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt;
      ECC_DIR=/acme.sh/$${DERP_DOMAIN}_ecc;

      if [ ! -s \"$$CERT_FILE\" ] || ! grep -q 'BEGIN CERTIFICATE' \"$$CERT_FILE\"; then
        echo 'ğŸš€ ç­¾å‘è¯ä¹¦: $$DERP_DOMAIN (server=$$ACME_SERVER)...';

        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ®‹ç•™ï¼ˆstaging â†’ prod åˆ‡æ¢å¿…é¡»æ¸…ç†æ—§ ECC ç›®å½•ï¼‰
        rm -rf /acme.sh/$${DERP_DOMAIN} /acme.sh/$${DERP_DOMAIN}_ecc 2>/dev/null || true;

        # âš ï¸ å…³é”®: ç›´æ¥è°ƒç”¨ acme.sh äºŒè¿›åˆ¶ï¼Œç»•å¼€ /entry.sh çš„ daemon socket relay
        # /entry.sh åœ¨ daemon è¿è¡Œæ—¶èµ° socket é€šä¿¡ï¼Œä¸€æ¬¡æ€§å®¹å™¨æ— æ³•æŒç»­ç›‘å¬å“åº”
        /acmebin/acme.sh --issue --server $$ACME_SERVER -d $$DERP_DOMAIN --dns dns_cf --keylength ec-256;
        ISSUE_RC=$$?;
        if [ $$ISSUE_RC -ne 0 ]; then
          echo 'âŒ è‡´å‘½é”™è¯¯: è¯ä¹¦ç­¾å‘å¤±è´¥ (é€€å‡ºç : '$$ISSUE_RC')';
          echo '   è¯·æ£€æŸ¥: 1) CF_Token æ˜¯å¦æœ‰ Zoneâ†’DNSâ†’Edit æƒé™ 2) LE é€Ÿç‡é™åˆ¶ 3) DERP_DOMAIN è§£ææ˜¯å¦æ­£ç¡®';
          exit 1;
        fi;

        # æ ¡éªŒ _ecc ç›®å½•å·²ç”± acme.sh åˆ›å»ºï¼Œå†æ‰§è¡Œ install-cert
        if [ ! -d \"$$ECC_DIR\" ]; then
          echo 'âŒ è‡´å‘½é”™è¯¯: ç­¾å‘å ECC ç›®å½• '$$ECC_DIR' ä¸å­˜åœ¨ï¼Œinstall-cert æ— æ³•ç»§ç»­';
          exit 1;
        fi;

        mkdir -p /acme.sh/$$DERP_DOMAIN;
        /acmebin/acme.sh --install-cert -d $$DERP_DOMAIN --ecc \
          --cert-file /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt \
          --key-file  /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key;

        echo 'ğŸ“‚ è¯ä¹¦ç›®å½•:'; ls -la /acme.sh/$$DERP_DOMAIN/;
        if [ ! -s \"$$CERT_FILE\" ] || ! grep -q 'BEGIN CERTIFICATE' \"$$CERT_FILE\"; then
          echo 'âŒ è‡´å‘½é”™è¯¯: install-cert åè¯ä¹¦æ–‡ä»¶ä¸ºç©ºï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—'; exit 1;
        fi;
        echo 'âœ… è¯ä¹¦ç­¾å‘å¹¶å®‰è£…æˆåŠŸ';
      else
        echo 'âœ… è¯ä¹¦å·²å­˜åœ¨ä¸”æœ‰æ•ˆ: $$DERP_DOMAIN';
        if [ \"$$ACME_STAGING\" = \"true\" ]; then
          echo 'âš ï¸  æ³¨æ„: å½“å‰è¯ä¹¦ä¸ºæµ‹è¯•è¯ä¹¦ï¼Œç”Ÿäº§åˆ‡æ¢å‰è¯·åˆ é™¤ data/acme/ ç›®å½•!';
        fi;
      fi;
      chmod 644 /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
      chmod 644 /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key 2>/dev/null || true;
      "



  # =========================================================================
  # Layer 1: æ ¸å¿ƒä¸šåŠ¡ (Business Logic)
  # =========================================================================

  # --- DERP ä¸­ç»§èŠ‚ç‚¹ (å”¯ä¸€å…è®¸æš´éœ²ç«¯å£çš„æœåŠ¡) ---
  derper:
    image: ghcr.io/fenlynn/derper:latest
    container_name: derper
    restart: unless-stopped
    ports:
      - "${DERP_PORT:-33445}:${DERP_PORT:-33445}"          # TCP åŠ å¯†ä¸­ç»§
      - "${DERP_STUN_PORT:-3478}:${DERP_STUN_PORT:-3478}/udp"  # UDP STUN æ‰“æ´
    environment:
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      - DERP_ADDR=:${DERP_PORT:-33445}
      - DERP_CERT_MODE=manual
      # ğŸ”’ é˜²ç™½å«–é‰´æƒ: éœ€è¦ VPS å®¿ä¸»æœºå·²è¿è¡Œ tailscaled å¹¶åŠ å…¥ Tailnet
      - DERP_VERIFY_CLIENTS=${DERP_VERIFY_CLIENTS:-true}
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme/${DERP_DOMAIN:-localhost}:/app/certs:ro
      # æŒ‚è½½ tailscaled socketï¼Œä¾› --verify-clients é‰´æƒå›è°ƒä½¿ç”¨
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      acme-init:
        condition: service_completed_successfully
    networks:
      - vps_tunnel_net


  # --- YesPlayMusic åç«¯ API ---
  music-api:
    image: ${MUSIC_API_IMAGE:-ghcr.io/fenlynn/netease_cloud_music_api:latest}
    container_name: music-api
    restart: unless-stopped
    # ç›´è¿ç½‘æ˜“äº‘ï¼Œé˜¿é‡Œäº‘ ECS å›½å†…ç›´è¿æ— é—®é¢˜
    # é˜²æ»¥ç”¨ï¼šå»ºè®®åœ¨ CF WAF é…ç½® Referer é™åˆ¶ï¼ˆè§æ–‡æ¡£ï¼‰
    environment:
      - ENABLE_FLAC=true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—® (music-api.660415.xyz)

  # --- Nginx Relay (å…¬ç§ç½‘æ¡¥æ¥ â†’ NAS) ---
  nginx-relay:
    image: ghcr.io/fenlynn/nginx:alpine
    container_name: nginx-relay
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/config/nginx-relay/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${BASE_DIR:-/opt/vps-dmz}/logs/nginx:/var/log/nginx
    # è®©å®¹å™¨èƒ½è®¿é—®å®¿ä¸»æœº (Linux bridge ç½‘ç»œä¸‹ host.docker.internal éœ€è¦æ­¤é…ç½®)
    # å®¿ä¸»æœºä¸Šè¿è¡Œ Tailscaleï¼Œå®¹å™¨é€šè¿‡å®¿ä¸»æœºè·¯ç”±åˆ° NAS
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    depends_on:
      - cloudflared
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®
    # âš ï¸ nginx access.log å†™å…¥ volumeï¼Œéœ€å®¿ä¸»æœº logrotate å•ç‹¬å¤„ç†ï¼ˆè§éƒ¨ç½²æ‰‹å†Œï¼‰


  # --- FastAPI ç»Ÿä¸€ç½‘å…³ ---
  fastapi-gateway:
    build:
      # æ”¹ä¸ºç›¸å¯¹è·¯å¾„ï¼Œæ— è®ºåœ¨å®¿ä¸»æœºè¿˜æ˜¯ Dockge å®¹å™¨å†…ï¼Œåªè¦æ˜¯å½“å‰æ ˆç›®å½•éƒ½èƒ½æ‰¾åˆ°
      context: ./config/fastapi-gateway
      dockerfile: Dockerfile
    image: vps-ops/fastapi-gateway:latest
    pull_policy: build
    container_name: fastapi-gateway
    restart: unless-stopped
    environment:
      # Token é‰´æƒ (ä¿æŠ¤ /ops/* è·¯ç”±ï¼Œæ›¿ä»£æ—§çš„ FASTAPI_SECRET_KEY)
      - VPS_TOKEN=${VPS_TOKEN:?VPS_TOKEN is required}
      - MUSIC_API_URL=http://music-api:3000
      - NGINX_RELAY_URL=http://nginx-relay:80
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - cloudflared
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Uptime Kuma (ç›‘æ§é¢æ¿) ---
  uptime-kuma:
    image: ghcr.io/fenlynn/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/uptime-kuma:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Kopia å¤‡ä»½ (å¢é‡å¤‡ä»½åˆ° Cloudflare R2) ---
  kopia:
    image: ${KOPIA_IMAGE:-ghcr.io/fenlynn/kopia:latest}
    container_name: kopia
    restart: unless-stopped
    hostname: vps-backup
    volumes:
      # æŒ‚è½½ data/ ç›®å½•ï¼ˆå¤‡ä»½ç›®æ ‡ï¼‰ï¼Œéœ€ç•™è¯»å†™æƒé™ä»¥å…è®¸ç¾åå…¨è‡ªåŠ¨æ¢å¤ (Restore)
      - ${BASE_DIR:-/opt/vps-dmz}/data:/source
      - kopia-cache:/app/cache
      - kopia-config:/app/config
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD:?KOPIA_PASSWORD is required}
      - R2_BUCKET=${R2_BUCKET}
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - KOPIA_CONFIG_PATH=/app/config/repository.config
      - KOPIA_CACHE_DIRECTORY=/app/cache
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo 'ğŸš€ Kopia å¯åŠ¨ (Cloudflare R2 ç‰ˆæœ¬)...';
        if [ -z "$KOPIA_PASSWORD" ]; then echo 'âŒ KOPIA_PASSWORD æœªè®¾ç½®!'; exit 1; fi;
        echo 'â³ å°è¯•è¿æ¥åˆ°å·²æœ‰ R2 ä»“åº“...';
        if kopia repository connect s3 --bucket="$$R2_BUCKET" --endpoint="$$R2_ENDPOINT_URL" --access-key="$$R2_ACCESS_KEY_ID" --secret-access-key="$$R2_SECRET_ACCESS_KEY" --override-hostname=vps-backup --override-username=root; then
            echo 'âœ… å·²æˆåŠŸè¿å…¥ R2 ç¾å¤‡åº“ï¼';
        else
            echo 'âš ï¸ ç°æœ‰ä»“åº“è¿æ¥å¤±è´¥ (è‹¥ä¸ºç©ºåº“å±æ­£å¸¸)ã€‚å°è¯•åˆå§‹åŒ–æ–°ä»“åº“...';
            if kopia repository create s3 --bucket="$$R2_BUCKET" --endpoint="$$R2_ENDPOINT_URL" --access-key="$$R2_ACCESS_KEY_ID" --secret-access-key="$$R2_SECRET_ACCESS_KEY" --override-hostname=vps-backup --override-username=root; then
                echo 'âœ… å…¨æ–° R2 ä»“åº“åˆå§‹åŒ–æˆåŠŸï¼';
            else
                echo 'âŒ è‡´å‘½é”™è¯¯ï¼šR2 ä»“åº“è¿æ¥ä¸åˆ›å»ºå‡å¤±è´¥ï¼è¯·æ£€æŸ¥ä½ çš„ R2 API ä»¤ç‰Œå’Œ Endpoint URLï¼';
                exit 1;
            fi
        fi
        kopia policy set --global --keep-daily 7 --keep-weekly 4 --keep-monthly 6;
        echo 'âœ… Kopia å°±ç»ªï¼Œç­‰å¾…å¤–éƒ¨ backup_kopia.sh è§¦å‘å¿«ç…§...';
        exec tail -f /dev/null

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # Layer 1.5: é™æ€å‰ç«¯ä¸šåŠ¡ (Frontend)
  # =========================================================================

  music-web:
    image: ghcr.io/fenlynn/yesplaymusic:latest
    container_name: music-web
    restart: unless-stopped
    environment:
      # åŒå­åŸŸåç›´è¿æ¶æ„ï¼šå‰ç«¯ç›´æ¥è°ƒç”¨ music-api å­åŸŸåï¼Œç»•è¿‡ nginx-relay
      # music-api.660415.xyz åœ¨ CF Access ä¸­è®¾ä¸º bypassï¼ˆæ— éœ€ç™»å½•ï¼‰
      - VUE_APP_NETEASE_API_URL=https://music-api.660415.xyz
      - NETEASE_API_URL=https://music-api.660415.xyz
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— æš´éœ²ç«¯å£ï¼Œç”± nginx-relay æˆ–è€… CF Tunnel ä»£ç†è®¿é—®
    depends_on:
      - cloudflared

  # --- Memos (é—ªå¿µç¬”è®°) ---
  # å¤šå®¢æˆ·ç«¯: Web / iOS App / Telegram Bot / API è„šæœ¬ å‡å¯è®¿é—®
  # CF Access: ç½‘é¡µç«¯ (memos.660415.xyz/*) éœ€è¦éªŒè¯
  #            API ç«¯  (memos.660415.xyz/api/*, /o/*) Bypass æ”¾è¡Œç»™ App å®¢æˆ·ç«¯
  memos:
    image: neosmemo/memos:stable
    container_name: memos
    restart: unless-stopped
    volumes:
      # SQLite æ•°æ®åº“å­˜å‚¨ï¼Œçº³å…¥ Kopia åŸå­å¤‡ä»½ï¼ˆbackup_kopia.sh ä¼šæš‚åœæ­¤å®¹å™¨ï¼‰
      - ${BASE_DIR:-/opt/vps-dmz}/data/memos:/var/opt/memos
    environment:
      # ç«¯å£é»˜è®¤ 5230ï¼ˆå®¹å™¨å†…ï¼‰ï¼ŒCF Tunnel ç›´æ¥æ˜ å°„ï¼Œå®¿ä¸»æœºä¸æš´éœ²
      - MEMOS_MODE=prod
      - MEMOS_PORT=5230
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    depends_on:
      - cloudflared

  # --- Alist (ç½‘ç›˜èšåˆ) ---
  # æ”¯æŒ: é˜¿é‡Œäº‘ç›˜ / ç™¾åº¦ç½‘ç›˜ / OneDrive / WebDAV / æœ¬åœ°å­˜å‚¨ ç­‰
  # å¤šå®¢æˆ·ç«¯: Web / Infuse(ç”µè§†) / WebDAV å®¢æˆ·ç«¯(iOS Files) / æ’­æ”¾å™¨
  # CF Access: ç®¡ç†ç½‘é¡µ (disk.660415.xyz/*) éœ€è¦éªŒè¯
  #            WebDAV  (disk.660415.xyz/dav/*) Bypass æ”¾è¡Œç»™ç”µè§†/æ’­æ”¾å™¨
  #            ç›´é“¾    (disk.660415.xyz/d/*, /p/*) Bypass æ”¾è¡Œç»™å®¢æˆ·ç«¯
  alist:
    image: xhofe/alist:latest
    container_name: alist
    restart: unless-stopped
    volumes:
      # Alist æ•°æ®ç›®å½•åŒ…å« SQLite æ•°æ®åº“å’Œé…ç½®ï¼Œçº³å…¥ Kopia åŸå­å¤‡ä»½
      - ${BASE_DIR:-/opt/vps-dmz}/data/alist:/opt/alist/data
    environment:
      # æ—¶åŒºè®¾ç½®
      - TZ=Asia/Shanghai
      # PUID/PGID ä¿æŒé»˜è®¤ 0 (root) ä»¥é¿å…æƒé™é—®é¢˜
      # åˆå§‹ç®¡ç†å‘˜å¯†ç é€šè¿‡ `docker exec alist ./alist admin set <PASSWORD>` è®¾ç½®
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    depends_on:
      - cloudflared


  # =========================================================================
  # Layer 2: ç®¡ç†é¢æ¿ (Management)
  # =========================================================================

  # --- Dozzle (è½»é‡çº§å®¹å™¨æ—¥å¿—é¢æ¿) ---
  # æè‡´è½»é‡ã€æ— éœ€é…ç½®çš„å®¹å™¨å®æ—¶æ—¥å¿—æŸ¥çœ‹å™¨ï¼Œå®Œç¾å¥‘åˆå½“å‰å‘½ä»¤è¡Œçš„æ¶æ„éƒ¨ç½²
  dozzle:
    image: ghcr.io/fenlynn/dozzle:latest
    container_name: dozzle
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # å»é™¤æ²¡ç”¨çš„åˆ†ææ”¶é›†
      - DOZZLE_NO_ANALYTICS=true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel + Access è®¿é—®

  # --- Homepage (æå®¢å¯¼èˆªä»ªè¡¨ç›˜) ---
  # çº¯é™æ€ã€é…ç½®å³ä»£ç ã€é«˜é¢œå€¼çš„æå®¢å¯¼èˆªé¡µã€‚æ”¯æŒæ·±åº¦å¯¹æ¥ Docker å’Œ NAS çš„ APIã€‚
  homepage:
    image: ghcr.io/fenlynn/homepage:latest
    container_name: homepage
    restart: unless-stopped
    volumes:
      # ğŸ”§ æ‰€æœ‰çš„é…ç½®(services.yaml, widgets.yamlç­‰)éƒ½ä¼šç”Ÿæˆå¹¶ä¿å­˜åœ¨è¿™ä¸ªçº¯æ–‡æœ¬æ–‡ä»¶å¤¹é‡Œ
      - ${BASE_DIR:-/opt/vps-dmz}/data/homepage:/app/config
      # æŒ‚è½½ Docker socket ä»¥æ”¯æŒè‡ªåŠ¨å‘ç°å®¹å™¨å’Œè¯»å–å®¹å™¨å®æ—¶çŠ¶æ€
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      # âœ… å®˜æ–¹æ­£ç¡®é…ç½®ï¼šæ˜¾å¼å£°æ˜å…è®¸è®¿é—®çš„ä¸»æœºåï¼Œè§£å†³ CF Tunnel ä¸‹çš„ Host Validation é”™è¯¯
      # å‚è€ƒï¼šhttps://gethomepage.dev/installation/docker/
      - HOMEPAGE_ALLOWED_HOSTS=home.660415.xyz
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel + Access è®¿é—® (Homepage å®¹å™¨å†…è¿è¡Œåœ¨ 3000 ç«¯å£)

# =============================================================================
# ç½‘ç»œå®šä¹‰
# =============================================================================
networks:
  vps_tunnel_net:
    external: true
    #name: vps_tunnel_net
      #  driver: bridge

# =============================================================================
# å‘½åå·
# =============================================================================
volumes:
  kopia-cache:
  kopia-config:
