
# =============================================================================
# VPS-OPS v2.0 â€” ç»Ÿä¸€æœåŠ¡ç¼–æ’æ–‡ä»¶
# æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€æ–‡ä»¶ä¸­ç®¡ç†ï¼Œé€šè¿‡ depends_on æ§åˆ¶å¯åŠ¨é¡ºåº
# é›¶ç«¯å£æš´éœ²æ¶æ„ï¼šé™¤ DERP å¤–ï¼Œæ‰€æœ‰æµé‡èµ° Cloudflare Tunnel
# =============================================================================

# â”€â”€â”€ å…¨å±€å˜é‡çº¦å®š â”€â”€â”€
# BASE_DIR      = /opt/vps-dmz          (å®¿ä¸»æœºæ ¹ç›®å½•)
# MAIN_DOMAIN   = 660415.xyz            (ä¸»åŸŸå)
# DERP_DOMAIN   = derp.660415.xyz       (DERP èŠ‚ç‚¹åŸŸå)
# ACME_STAGING  = true | false
#   true  â†’ ä½¿ç”¨ Let's Encrypt æµ‹è¯•æœåŠ¡å™¨ (æ— é™æ¬¡æ•°ï¼Œè¯ä¹¦ä¸å—ä¿¡ä»»ï¼Œç”¨äºè°ƒè¯•)
#   false â†’ ä½¿ç”¨ Let's Encrypt ç”Ÿäº§æœåŠ¡å™¨ (æ­£å¼è¯ä¹¦ï¼Œæ¯åŸŸåæ¯å‘¨é™5æ¬¡)

services:

  # =========================================================================
  # Layer 0: åŸºç¡€è®¾æ–½ (Infrastructure)
  # =========================================================================

  # --- Cloudflare Tunnel (å®‰å…¨å…¥å£) ---
  cloudflared:
    image: ghcr.io/fenlynn/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token ${CF_TOKEN:?CF_TOKEN is required}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- è¯ä¹¦ç®¡ç† (acme.sh daemon å¸¸é©») ---
  acme:
    image: ghcr.io/fenlynn/acme.sh:latest
    container_name: acme
    restart: unless-stopped
    command: daemon
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:?CF_DNS_API_TOKEN is required}
      - CF_Account_ID=${CLOUDFLARE_ACCOUNT_ID:-}
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    network_mode: host

  # --- é¦–æ¬¡è¯ä¹¦ç­¾å‘ (ä¸€æ¬¡æ€§ä»»åŠ¡) ---
  acme-init:
    image: ghcr.io/fenlynn/acme.sh:latest
    container_name: acme-init
    depends_on:
      - acme
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:?CF_DNS_API_TOKEN is required}
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      # âš™ï¸ æµ‹è¯•æ¨¡å¼å¼€å…³
      # ACME_STAGING=true  â†’ ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨(æ— é™æ¬¡ï¼Œè¯ä¹¦ä¸å—ä¿¡ä»»)
      # ACME_STAGING=false â†’ ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨(æ­£å¼è¯ä¹¦ï¼Œæœ‰é€Ÿç‡é™åˆ¶)
      - ACME_STAGING=${ACME_STAGING:-false}
    network_mode: host
    restart: "no"
    command: |
      /bin/sh -c "
      sleep 10;

      # æ ¹æ® ACME_STAGING é€‰æ‹© CA æœåŠ¡å™¨
      if [ \"$$ACME_STAGING\" = \"true\" ]; then
        ACME_SERVER=letsencrypt_test;
        echo 'âš ï¸  [STAGING MODE] ä½¿ç”¨ Let'\''s Encrypt æµ‹è¯•æœåŠ¡å™¨ - è¯ä¹¦ä¸å—æµè§ˆå™¨ä¿¡ä»»!';
      else
        ACME_SERVER=letsencrypt;
        echo 'ğŸ”’ [PROD MODE] ä½¿ç”¨ Let'\''s Encrypt ç”Ÿäº§æœåŠ¡å™¨';
      fi;

      if [ ! -s /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt ] || ! grep -q 'BEGIN CERTIFICATE' /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt; then
        echo 'ğŸš€ ç­¾å‘è¯ä¹¦: $$DERP_DOMAIN (server=$$ACME_SERVER)...';
        rm -rf /acme.sh/$$DERP_DOMAIN/*;
        /entry.sh --issue --server $$ACME_SERVER -d $$DERP_DOMAIN --dns dns_cf --keylength ec-256;
        mkdir -p /acme.sh/$$DERP_DOMAIN;
        /entry.sh --install-cert -d $$DERP_DOMAIN --ecc \\
          --cert-file /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt \\
          --key-file /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key;
        # å›é€€: ä» _ecc ç›®å½•å¼ºåˆ¶æ‹·è´
        if [ ! -s /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt ]; then
          echo 'âš ï¸ æ ‡å‡†å®‰è£…æœªæˆåŠŸï¼Œä» ECC ç›®å½•å¼ºåˆ¶æ‹·è´...';
          cp -f /acme.sh/$${DERP_DOMAIN}_ecc/$${DERP_DOMAIN}.cer /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
          cp -f /acme.sh/$${DERP_DOMAIN}_ecc/$${DERP_DOMAIN}.crt /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
          cp -f /acme.sh/$${DERP_DOMAIN}_ecc/$${DERP_DOMAIN}.key /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key 2>/dev/null || true;
        fi
        echo 'ğŸ“‚ è¯ä¹¦ç›®å½•:'; ls -la /acme.sh/$$DERP_DOMAIN/;
        if [ ! -s /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt ] || ! grep -q 'BEGIN CERTIFICATE' /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt; then
          echo 'âŒ è‡´å‘½é”™è¯¯: è¯ä¹¦ç­¾å‘å¤±è´¥'; exit 1;
        fi
      else
        echo 'âœ… è¯ä¹¦å·²å­˜åœ¨: $$DERP_DOMAIN';
        if [ \"$$ACME_STAGING\" = \"true\" ]; then
          echo 'âš ï¸  æ³¨æ„: å½“å‰è¯ä¹¦ä¸ºæµ‹è¯•è¯ä¹¦ï¼Œåˆ‡æ¢åˆ°ç”Ÿäº§å‰è¯·åˆ é™¤ data/acme/ ç›®å½•!';
        fi
      fi;
      chmod 644 /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
      chmod 644 /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key 2>/dev/null || true;
      "



  # =========================================================================
  # Layer 1: æ ¸å¿ƒä¸šåŠ¡ (Business Logic)
  # =========================================================================

  # --- DERP ä¸­ç»§èŠ‚ç‚¹ (å”¯ä¸€å…è®¸æš´éœ²ç«¯å£çš„æœåŠ¡) ---
  derper:
    image: ghcr.io/fenlynn/derper:latest
    container_name: derper
    restart: unless-stopped
    ports:
      - "${DERP_PORT:-33445}:${DERP_PORT:-33445}"          # TCP åŠ å¯†ä¸­ç»§
      - "${DERP_STUN_PORT:-3478}:${DERP_STUN_PORT:-3478}/udp"  # UDP STUN æ‰“æ´
    environment:
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      - DERP_ADDR=:${DERP_PORT:-33445}
      - DERP_CERT_MODE=manual
      # ğŸ”’ é˜²ç™½å«–é‰´æƒ: éœ€è¦ VPS å®¿ä¸»æœºå·²è¿è¡Œ tailscaled å¹¶åŠ å…¥ Tailnet
      - DERP_VERIFY_CLIENTS=${DERP_VERIFY_CLIENTS:-true}
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme/${DERP_DOMAIN:-localhost}:/app/certs:ro
      # æŒ‚è½½ tailscaled socketï¼Œä¾› --verify-clients é‰´æƒå›è°ƒä½¿ç”¨
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      acme-init:
        condition: service_completed_successfully
    networks:
      - vps_tunnel_net


  # --- YesPlayMusic åç«¯ API ---
  music-api:
    image: ${MUSIC_API_IMAGE:-ghcr.io/fenlynn/netease_cloud_music_api:latest}
    container_name: music-api
    restart: unless-stopped
    # ç›´è¿ç½‘æ˜“äº‘ï¼Œé˜¿é‡Œäº‘ ECS å›½å†…ç›´è¿æ— é—®é¢˜
    # é˜²æ»¥ç”¨ï¼šå»ºè®®åœ¨ CF WAF é…ç½® Referer é™åˆ¶ï¼ˆè§æ–‡æ¡£ï¼‰
    environment:
      - ENABLE_FLAC=true
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—® (music-api.660415.xyz)

  # --- Nginx Relay (å…¬ç§ç½‘æ¡¥æ¥ â†’ NAS) ---
  nginx-relay:
    image: ghcr.io/fenlynn/nginx:alpine
    container_name: nginx-relay
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/config/nginx-relay/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${BASE_DIR:-/opt/vps-dmz}/logs/nginx:/var/log/nginx
    # è®©å®¹å™¨èƒ½è®¿é—®å®¿ä¸»æœº (Linux bridge ç½‘ç»œä¸‹ host.docker.internal éœ€è¦æ­¤é…ç½®)
    # å®¿ä¸»æœºä¸Šè¿è¡Œ Tailscaleï¼Œå®¹å™¨é€šè¿‡å®¿ä¸»æœºè·¯ç”±åˆ° NAS
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    depends_on:
      - cloudflared
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®
    # âš ï¸ nginx access.log å†™å…¥ volumeï¼Œéœ€å®¿ä¸»æœº logrotate å•ç‹¬å¤„ç†ï¼ˆè§éƒ¨ç½²æ‰‹å†Œï¼‰


  # --- FastAPI ç»Ÿä¸€ç½‘å…³ ---
  fastapi-gateway:
    build:
      # æ”¹ä¸ºç›¸å¯¹è·¯å¾„ï¼Œæ— è®ºåœ¨å®¿ä¸»æœºè¿˜æ˜¯ Dockge å®¹å™¨å†…ï¼Œåªè¦æ˜¯å½“å‰æ ˆç›®å½•éƒ½èƒ½æ‰¾åˆ°
      context: ./config/fastapi-gateway
      dockerfile: Dockerfile
    image: vps-ops/fastapi-gateway:latest
    pull_policy: build
    container_name: fastapi-gateway
    restart: unless-stopped
    environment:
      # Token é‰´æƒ (ä¿æŠ¤ /ops/* è·¯ç”±ï¼Œæ›¿ä»£æ—§çš„ FASTAPI_SECRET_KEY)
      - VPS_TOKEN=${VPS_TOKEN:?VPS_TOKEN is required}
      - MUSIC_API_URL=http://music-api:3000
      - NGINX_RELAY_URL=http://nginx-relay:80
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - cloudflared
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Uptime Kuma (ç›‘æ§é¢æ¿) ---
  uptime-kuma:
    image: ghcr.io/fenlynn/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/uptime-kuma:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Kopia å¤‡ä»½ (å¢é‡å¤‡ä»½åˆ° Cloudflare R2) ---
  kopia:
    image: ${KOPIA_IMAGE:-ghcr.io/fenlynn/kopia:latest}
    container_name: kopia
    restart: unless-stopped
    hostname: vps-backup
    volumes:
      # ä»…æŒ‚è½½ data/ ç›®å½•ï¼ˆå¤‡ä»½ç›®æ ‡ï¼‰ï¼Œä¸æŒ‚è½½ logs/
      - ${BASE_DIR:-/opt/vps-dmz}/data:/source:ro
      - kopia-cache:/app/cache
      - kopia-config:/app/config
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD:?KOPIA_PASSWORD is required}
      - R2_BUCKET=${R2_BUCKET}
      - R2_ENDPOINT_URL=${R2_ENDPOINT_URL}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
    entrypoint:
      - /bin/sh
      - -c
      - |
        echo 'ğŸš€ Kopia å¯åŠ¨ (Cloudflare R2 ç‰ˆæœ¬)...';
        if [ -z "$KOPIA_PASSWORD" ]; then echo 'âŒ KOPIA_PASSWORD æœªè®¾ç½®!'; exit 1; fi;
        kopia repository connect s3 --bucket="$R2_BUCKET" --endpoint="$R2_ENDPOINT_URL" --access-key="$R2_ACCESS_KEY_ID" --secret-access-key="$R2_SECRET_ACCESS_KEY" --override-hostname=vps-backup --override-username=root || kopia repository create s3 --bucket="$R2_BUCKET" --endpoint="$R2_ENDPOINT_URL" --access-key="$R2_ACCESS_KEY_ID" --secret-access-key="$R2_SECRET_ACCESS_KEY" --override-hostname=vps-backup --override-username=root;
        kopia policy set --global --keep-daily 7 --keep-weekly 4 --keep-monthly 6;
        echo 'âœ… Kopia å°±ç»ªï¼Œç­‰å¾…å¤–éƒ¨ backup_kopia.sh è§¦å‘å¿«ç…§...';
        tail -f /dev/null

    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # Layer 1.5: é™æ€å‰ç«¯ä¸šåŠ¡ (Frontend)
  # =========================================================================

  # --- YesPlayMusic çº¯å‰ç«¯é¡µé¢ ---
  music-web:
    image: ghcr.io/fenlynn/yesplaymusic:latest
    container_name: music-web
    restart: unless-stopped
    environment:
      # åŒå­åŸŸåç›´è¿æ¶æ„ï¼šå‰ç«¯ç›´æ¥è°ƒç”¨ music-api å­åŸŸåï¼Œç»•è¿‡ nginx-relay
      # music-api.660415.xyz åœ¨ CF Access ä¸­è®¾ä¸º bypassï¼ˆæ— éœ€ç™»å½•ï¼‰
      - VUE_APP_NETEASE_API_URL=https://music-api.660415.xyz
      - NETEASE_API_URL=https://music-api.660415.xyz
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— æš´éœ²ç«¯å£ï¼Œç”± nginx-relay æˆ–è€… CF Tunnel ä»£ç†è®¿é—®
    depends_on:
      - cloudflared

  # =========================================================================
  # Layer 2: ç®¡ç†é¢æ¿ (Management)
  # =========================================================================

  # --- Dockge (å®¹å™¨ç®¡ç†) ---
  dockge:
    image: ghcr.io/fenlynn/dockge:1
    container_name: dockge
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${BASE_DIR:-/opt/vps-dmz}/data/dockge:/app/data
      # æŒ‚è½½æ•´ä¸ªé¡¹ç›®ç›®å½•ä¸º Dockge ä¸­çš„ "vps-dmz" æ ˆï¼ˆä¸ä½ å¤–å±‚çš„ç›®å½•åä¿æŒä¸€è‡´ï¼‰
      - ${BASE_DIR:-/opt/vps-dmz}:/app/stacks/vps-dmz
    environment:
      # å›å½’é»˜è®¤ï¼ŒDockge ä¼šæ‰«ææ­¤ç›®å½•ä¸‹çš„å­æ–‡ä»¶å¤¹ä½œä¸ºæ ˆ
      - DOCKGE_STACKS_DIR=/app/stacks
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel + Access è®¿é—®

  # --- Homarr (å¯¼èˆªä»ªè¡¨ç›˜) ---
  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/homarr/configs:/app/data/configs
      - ${BASE_DIR:-/opt/vps-dmz}/data/homarr/icons:/app/public/icons
      - /var/run/docker.sock:/var/run/docker.sock:ro
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel + Access è®¿é—®

# =============================================================================
# ç½‘ç»œå®šä¹‰
# =============================================================================
networks:
  vps_tunnel_net:
    external: true
    #name: vps_tunnel_net
      #  driver: bridge

# =============================================================================
# å‘½åå·
# =============================================================================
volumes:
  kopia-cache:
  kopia-config:
