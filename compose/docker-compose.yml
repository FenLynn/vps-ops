
# =============================================================================
# VPS-OPS v2.0 â€” ç»Ÿä¸€æœåŠ¡ç¼–æ’æ–‡ä»¶
# æ‰€æœ‰æœåŠ¡åœ¨åŒä¸€æ–‡ä»¶ä¸­ç®¡ç†ï¼Œé€šè¿‡ depends_on æ§åˆ¶å¯åŠ¨é¡ºåº
# é›¶ç«¯å£æš´éœ²æ¶æ„ï¼šé™¤ DERP å¤–ï¼Œæ‰€æœ‰æµé‡èµ° Cloudflare Tunnel
# =============================================================================

# â”€â”€â”€ å…¨å±€å˜é‡çº¦å®š â”€â”€â”€
# BASE_DIR      = /opt/vps-dmz          (å®¿ä¸»æœºæ ¹ç›®å½•)
# MAIN_DOMAIN   = 660415.xyz            (ä¸»åŸŸå)
# DERP_DOMAIN   = derp.660415.xyz       (DERP èŠ‚ç‚¹åŸŸå)
# ACME_STAGING  = true | false
#   true  â†’ ä½¿ç”¨ Let's Encrypt æµ‹è¯•æœåŠ¡å™¨ (æ— é™æ¬¡æ•°ï¼Œè¯ä¹¦ä¸å—ä¿¡ä»»ï¼Œç”¨äºè°ƒè¯•)
#   false â†’ ä½¿ç”¨ Let's Encrypt ç”Ÿäº§æœåŠ¡å™¨ (æ­£å¼è¯ä¹¦ï¼Œæ¯åŸŸåæ¯å‘¨é™5æ¬¡)

services:

  # =========================================================================
  # Layer 0: åŸºç¡€è®¾æ–½ (Infrastructure)
  # =========================================================================

  # --- Cloudflare Tunnel (å®‰å…¨å…¥å£) ---
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run --token ${CF_TOKEN:?CF_TOKEN is required}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    healthcheck:
      test: ["CMD", "cloudflared", "tunnel", "info"]
      interval: 30s
      timeout: 10s
      retries: 5

  # --- è¯ä¹¦ç®¡ç† (acme.sh daemon å¸¸é©») ---
  acme:
    image: neilpang/acme.sh:latest
    container_name: acme
    restart: unless-stopped
    command: daemon
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:?CF_DNS_API_TOKEN is required}
      - CF_Account_ID=${CLOUDFLARE_ACCOUNT_ID:-}
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    network_mode: host

  # --- é¦–æ¬¡è¯ä¹¦ç­¾å‘ (ä¸€æ¬¡æ€§ä»»åŠ¡) ---
  acme-init:
    image: neilpang/acme.sh:latest
    container_name: acme-init
    depends_on:
      - acme
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme:/acme.sh
    environment:
      - CF_Token=${CF_DNS_API_TOKEN:?CF_DNS_API_TOKEN is required}
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      # âš™ï¸ æµ‹è¯•æ¨¡å¼å¼€å…³
      # ACME_STAGING=true  â†’ ä½¿ç”¨æµ‹è¯•æœåŠ¡å™¨(æ— é™æ¬¡ï¼Œè¯ä¹¦ä¸å—ä¿¡ä»»)
      # ACME_STAGING=false â†’ ä½¿ç”¨ç”Ÿäº§æœåŠ¡å™¨(æ­£å¼è¯ä¹¦ï¼Œæœ‰é€Ÿç‡é™åˆ¶)
      - ACME_STAGING=${ACME_STAGING:-false}
    network_mode: host
    restart: "no"
    command: |
      /bin/sh -c "
      sleep 10;

      # æ ¹æ® ACME_STAGING é€‰æ‹© CA æœåŠ¡å™¨
      if [ \"$$ACME_STAGING\" = \"true\" ]; then
        ACME_SERVER=letsencrypt_test;
        echo 'âš ï¸  [STAGING MODE] ä½¿ç”¨ Let'\''s Encrypt æµ‹è¯•æœåŠ¡å™¨ - è¯ä¹¦ä¸å—æµè§ˆå™¨ä¿¡ä»»!';
      else
        ACME_SERVER=letsencrypt;
        echo 'ğŸ”’ [PROD MODE] ä½¿ç”¨ Let'\''s Encrypt ç”Ÿäº§æœåŠ¡å™¨';
      fi;

      if [ ! -s /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt ] || ! grep -q 'BEGIN CERTIFICATE' /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt; then
        echo 'ğŸš€ ç­¾å‘è¯ä¹¦: $$DERP_DOMAIN (server=$$ACME_SERVER)...';
        rm -rf /acme.sh/$$DERP_DOMAIN/*;
        /entry.sh --issue --server $$ACME_SERVER -d $$DERP_DOMAIN --dns dns_cf --keylength ec-256;
        mkdir -p /acme.sh/$$DERP_DOMAIN;
        /entry.sh --install-cert -d $$DERP_DOMAIN --ecc \\
          --cert-file /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt \\
          --key-file /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key;
        # å›é€€: ä» _ecc ç›®å½•å¼ºåˆ¶æ‹·è´
        if [ ! -s /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt ]; then
          echo 'âš ï¸ æ ‡å‡†å®‰è£…æœªæˆåŠŸï¼Œä» ECC ç›®å½•å¼ºåˆ¶æ‹·è´...';
          cp -f /acme.sh/$${DERP_DOMAIN}_ecc/$${DERP_DOMAIN}.cer /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
          cp -f /acme.sh/$${DERP_DOMAIN}_ecc/$${DERP_DOMAIN}.crt /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
          cp -f /acme.sh/$${DERP_DOMAIN}_ecc/$${DERP_DOMAIN}.key /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key 2>/dev/null || true;
        fi
        echo 'ğŸ“‚ è¯ä¹¦ç›®å½•:'; ls -la /acme.sh/$$DERP_DOMAIN/;
        if [ ! -s /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt ] || ! grep -q 'BEGIN CERTIFICATE' /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt; then
          echo 'âŒ è‡´å‘½é”™è¯¯: è¯ä¹¦ç­¾å‘å¤±è´¥'; exit 1;
        fi
      else
        echo 'âœ… è¯ä¹¦å·²å­˜åœ¨: $$DERP_DOMAIN';
        if [ \"$$ACME_STAGING\" = \"true\" ]; then
          echo 'âš ï¸  æ³¨æ„: å½“å‰è¯ä¹¦ä¸ºæµ‹è¯•è¯ä¹¦ï¼Œåˆ‡æ¢åˆ°ç”Ÿäº§å‰è¯·åˆ é™¤ data/acme/ ç›®å½•!';
        fi
      fi;
      chmod 644 /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.crt 2>/dev/null || true;
      chmod 644 /acme.sh/$$DERP_DOMAIN/$$DERP_DOMAIN.key 2>/dev/null || true;
      "



  # =========================================================================
  # Layer 1: æ ¸å¿ƒä¸šåŠ¡ (Business Logic)
  # =========================================================================

  # --- DERP ä¸­ç»§èŠ‚ç‚¹ (å”¯ä¸€å…è®¸æš´éœ²ç«¯å£çš„æœåŠ¡) ---
  derper:
    image: ghcr.io/fenlynn/derper:latest
    container_name: derper
    restart: unless-stopped
    ports:
      - "${DERP_PORT:-33445}:${DERP_PORT:-33445}"          # TCP åŠ å¯†ä¸­ç»§
      - "${DERP_STUN_PORT:-3478}:${DERP_STUN_PORT:-3478}/udp"  # UDP STUN æ‰“æ´
    environment:
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      - DERP_ADDR=:${DERP_PORT:-33445}
      - DERP_CERT_MODE=manual
      # ğŸ”’ é˜²ç™½å«–é‰´æƒ: éœ€è¦ VPS å®¿ä¸»æœºå·²è¿è¡Œ tailscaled å¹¶åŠ å…¥ Tailnet
      - DERP_VERIFY_CLIENTS=${DERP_VERIFY_CLIENTS:-true}
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/acme/${DERP_DOMAIN:-localhost}:/app/certs:ro
      # æŒ‚è½½ tailscaled socketï¼Œä¾› --verify-clients é‰´æƒå›è°ƒä½¿ç”¨
      - /var/run/tailscale/tailscaled.sock:/var/run/tailscale/tailscaled.sock:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      acme-init:
        condition: service_completed_successfully
    networks:
      - vps_tunnel_net

  # --- New API (AI æ¥å£ç½‘å…³) ---
  new-api:
    image: calciumion/new-api:latest
    container_name: new-api
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/new-api:/data
      - ${BASE_DIR:-/opt/vps-dmz}/logs/new-api:/logs
    environment:
      # SQLite æ¨¡å¼ï¼šä¸»åº“åœ¨ /dataï¼Œæ—¥å¿—åº“éš”ç¦»åˆ° /logs
      - DB_TYPE=sqlite
      #- SQL_DSN=/data/new-api.db
      #- LOG_SQL_DSN=/logs/api-log.db
      - NODE_TYPE=master
      - CHANNEL_UPDATE_FREQUENCY=30
      - BATCH_UPDATE_ENABLED=true
      - GLOBAL_API_RATE_LIMIT=180
      - GLOBAL_WEB_RATE_LIMIT=60
      - INITIAL_ROOT_TOKEN=${NEW_API_ADMIN_PASSWORD:-}
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"   # å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§ 10MB
        max-file: "3"     # æœ€å¤šä¿ç•™ 3 ä¸ªæ»šåŠ¨æ–‡ä»¶

    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- ç½‘æ˜“äº‘è§£ç°ä»£ç† ---
  unblock-netease:
    image: ghcr.io/fenlynn/unblock-netease-music-enhanced:latest
    container_name: unblock-netease
    restart: unless-stopped
#    command: ["-p", "8080", "-s", "-e"]   # ğŸ‘ˆ å¿…é¡»è¡¥ä¸Šè¿™ä¸€è¡Œï¼(å¼€å¯ä¸¥æ ¼æ¨¡å¼ä¸å‰ç«¯ç«¯ç‚¹æ¨¡å¼)
    command: ["-p", "8080:8081"]
    environment:
      - NODE_ENV=production
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net

  # --- YesPlayMusic åç«¯ API ---
  music-api:
    image: ${MUSIC_API_IMAGE:-binaryify/netease_cloud_music_api:latest}
    container_name: music-api
    restart: unless-stopped
    environment:
      # å¼ºåˆ¶é€šè¿‡è§£ç°ä»£ç†è®¿é—®
      - HTTP_PROXY=http://unblock-netease:8080
      - HTTPS_PROXY=http://unblock-netease:8080
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - unblock-netease
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Nginx Relay (å…¬ç§ç½‘æ¡¥æ¥ â†’ NAS) ---
  nginx-relay:
    image: nginx:alpine
    container_name: nginx-relay
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/config/nginx-relay/nginx.conf:/etc/nginx/nginx.conf:ro
      - ${BASE_DIR:-/opt/vps-dmz}/logs/nginx:/var/log/nginx
    # è®©å®¹å™¨èƒ½è®¿é—®å®¿ä¸»æœº (Linux bridge ç½‘ç»œä¸‹ host.docker.internal éœ€è¦æ­¤é…ç½®)
    # å®¿ä¸»æœºä¸Šè¿è¡Œ Tailscaleï¼Œå®¹å™¨é€šè¿‡å®¿ä¸»æœºè·¯ç”±åˆ° NAS
    extra_hosts:
      - "host.docker.internal:host-gateway"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    depends_on:
      - cloudflared
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®
    # âš ï¸ nginx access.log å†™å…¥ volumeï¼Œéœ€å®¿ä¸»æœº logrotate å•ç‹¬å¤„ç†ï¼ˆè§éƒ¨ç½²æ‰‹å†Œï¼‰


  # --- FastAPI ç»Ÿä¸€ç½‘å…³ ---
  fastapi-gateway:
    build:
      context: ${BASE_DIR:-/opt/vps-dmz}/config/fastapi-gateway
      dockerfile: Dockerfile
    image: vps-ops/fastapi-gateway:latest
    pull_policy: build
    container_name: fastapi-gateway
    restart: unless-stopped
    environment:
      # Token é‰´æƒ (ä¿æŠ¤ /ops/* è·¯ç”±ï¼Œæ›¿ä»£æ—§çš„ FASTAPI_SECRET_KEY)
      - VPS_TOKEN=${VPS_TOKEN:?VPS_TOKEN is required}
      - NEW_API_URL=http://new-api:3000
      - MUSIC_API_URL=http://music-api:3000
      - NGINX_RELAY_URL=http://nginx-relay:80
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - cloudflared
      - new-api
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Uptime Kuma (ç›‘æ§é¢æ¿) ---
  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/uptime-kuma:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel è®¿é—®

  # --- Kopia å¤‡ä»½ (å¢é‡å¤‡ä»½åˆ° WebDAV) ---
  kopia:
    image: ${KOPIA_IMAGE:-ghcr.io/fenlynn/kopia:latest}
    container_name: kopia
    restart: unless-stopped
    hostname: vps-backup
    volumes:
      # ä»…æŒ‚è½½ data/ ç›®å½•ï¼ˆå¤‡ä»½ç›®æ ‡ï¼‰ï¼Œä¸æŒ‚è½½ logs/
      - ${BASE_DIR:-/opt/vps-dmz}/data:/source:ro
      - kopia-cache:/app/cache
      - kopia-config:/app/config
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD:?KOPIA_PASSWORD is required}
    entrypoint: |
      /bin/sh -c "
      echo 'ğŸš€ Kopia å¯åŠ¨...';
      if [ -z \"$$KOPIA_PASSWORD\" ]; then echo 'âŒ KOPIA_PASSWORD æœªè®¾ç½®!'; exit 1; fi;

      # è¿æ¥æˆ–åˆ›å»ºä»“åº“
      kopia repository connect webdav \
        --url=${WEBDAV_URL} \
        --webdav-username=${WEBDAV_USER} \
        --webdav-password=${WEBDAV_PASS} \
        --override-hostname=vps-backup \
        --override-username=root || \
      kopia repository create webdav \
        --url=${WEBDAV_URL} \
        --webdav-username=${WEBDAV_USER} \
        --webdav-password=${WEBDAV_PASS} \
        --override-hostname=vps-backup \
        --override-username=root;

      # å…¨å±€ä¿ç•™ç­–ç•¥
      kopia policy set --global --keep-daily 7 --keep-weekly 4 --keep-monthly 6;

      echo 'âœ… Kopia å°±ç»ªï¼Œç­‰å¾…å¤–éƒ¨ backup_kopia.sh è§¦å‘å¿«ç…§...';
      # ä¿æŒå®¹å™¨è¿è¡Œï¼Œç”±å®¿ä¸»æœº crontab è°ƒç”¨ docker exec è§¦å‘å¤‡ä»½
      tail -f /dev/null
      "
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"

  # =========================================================================
  # Layer 1.5: é™æ€å‰ç«¯ä¸šåŠ¡ (Frontend)
  # =========================================================================

  # --- YesPlayMusic çº¯å‰ç«¯é¡µé¢ ---
  music-web:
    image: qier222/yesplaymusic:latest
    container_name: music-web
    restart: unless-stopped
    environment:
      # è¿™ä¸ªç¯å¢ƒå˜é‡æ§åˆ¶å‰ç«¯å¾€å“ªé‡Œå‘è¯·æ±‚ã€‚æ³¨æ„ï¼šè¿™é‡Œå¿…é¡»å¡«åŒ…å«åŸŸåçš„å…¬ç½‘ URL (ç”± Nginx åä»£)
      - VUE_APP_NETEASE_API_URL=https://music.660415.xyz/api
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— æš´éœ²ç«¯å£ï¼Œç”± nginx-relay æˆ–è€… CF Tunnel ä»£ç†è®¿é—®
    depends_on:
      - cloudflared

  # =========================================================================
  # Layer 2: ç®¡ç†é¢æ¿ (Management)
  # =========================================================================

  # --- Dockge (å®¹å™¨ç®¡ç†) ---
  dockge:
    image: louislam/dockge:1
    container_name: dockge
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${BASE_DIR:-/opt/vps-dmz}/data/dockge:/app/data
    environment:
      - DOCKGE_STACKS_DIR=/app/stacks
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel + Access è®¿é—®

  # --- Homarr (å¯¼èˆªä»ªè¡¨ç›˜) ---
  homarr:
    image: ghcr.io/ajnart/homarr:latest
    container_name: homarr
    restart: unless-stopped
    volumes:
      - ${BASE_DIR:-/opt/vps-dmz}/data/homarr/configs:/app/data/configs
      - ${BASE_DIR:-/opt/vps-dmz}/data/homarr/icons:/app/public/icons
      - /var/run/docker.sock:/var/run/docker.sock:ro
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "2"
    networks:
      - vps_tunnel_net
    # ğŸš« æ— ç«¯å£æš´éœ²ï¼Œé€šè¿‡ CF Tunnel + Access è®¿é—®

# =============================================================================
# ç½‘ç»œå®šä¹‰
# =============================================================================
networks:
  vps_tunnel_net:
    external: true
    #name: vps_tunnel_net
      #  driver: bridge

# =============================================================================
# å‘½åå·
# =============================================================================
volumes:
  kopia-cache:
  kopia-config:
