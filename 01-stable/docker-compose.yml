services:
  # 1. Derp Server (High Availability Connector)
  derper:
    env_file: ../.env
    image: hub.rat.dev/fredliang/derper:latest
    container_name: derper
    restart: unless-stopped
    ports:
      - "${DERP_PORT:-33445}:${DERP_PORT:-33445}"
      - "${DERP_STUN_PORT:-3478}:${DERP_STUN_PORT:-3478}/udp"
    environment:
      - DERP_DOMAIN=${DERP_DOMAIN:-localhost}
      - DERP_ADDR=:${DERP_PORT:-33445}
      - DERP_CERT_MODE=manual
    volumes:
      # Mount certs from Layer 0 acme.sh
      - ${DOCKER_ROOT:-/nfs/docker}/global/certs/${DERP_DOMAIN:-localhost}:/app/certs
    networks:
      - vps-net

  # 2. AI Gateway (New API)
  new-api:
    env_file: ../.env
    image: hub.rat.dev/calciumion/new-api:latest
    container_name: new-api
    restart: unless-stopped
    volumes:
      - ${DOCKER_ROOT:-/nfs/docker}/stable/new-api:/data
    environment:
      - SQL_DSN=foo:bar@tcp(localhost:3306)/oneapi # Dummy if DB_TYPE is set? No.
      # For SQLite, the easiest way is to NOT set SQL_DSN or set it to a valid path and Ensure DB_TYPE is sqlite
      - DB_TYPE=sqlite
      - SQL_DSN=
      - NODE_TYPE=master
      - CHANNEL_UPDATE_FREQUENCY=30
      - BATCH_UPDATE_ENABLED=true
      - GLOBAL_API_RATE_LIMIT=180
      - GLOBAL_WEB_RATE_LIMIT=60
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - vps-net
    # No ports exposed, access via Cloudflare Tunnel

  # 3. Uptime Kuma (Monitoring)
  uptime-kuma:
    env_file: ../.env
    image: hub.rat.dev/louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - ${DOCKER_ROOT:-/nfs/docker}/stable/uptime-kuma:/app/data
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3001 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - vps-net
    # No ports exposed, access via Cloudflare Tunnel

  # 4. Kopia Backup (Incremental to WebDAV)
  kopia:
    env_file: ../.env
    image: kopia/kopia:latest
    container_name: kopia
    restart: unless-stopped
    hostname: vps-backup
    # Mount Docker Root RO for backup
    volumes:
      - ${DOCKER_ROOT:-/nfs/docker}:/source:ro
      - kopia-cache:/app/cache
      - kopia-config:/app/config
    environment:
      - KOPIA_PASSWORD=${KOPIA_PASSWORD:?err}
      # Cron schedule: Daily at 3 AM
      - KOPIA_JOB_SCHEDULE=0 3 * * *
    # Startup: Connect to repo -> Server mode
    # Note: Initial init must be done via 'docker exec' if repo doesn't exist?
    # Actually, let's use a simple looped script or entrypoint override for auto-c/n
    entrypoint: |
      /bin/sh -c "
      echo 'üöÄ Kopia Starting...';
      if [ -z \"\$KOPIA_PASSWORD\" ]; then echo '‚ùå KOPIA_PASSWORD not set!'; exit 1; fi;
      
      # Attempt to connect to existing repo
      kopia repository connect webdav \\
        --url=\${WEBDAV_URL} \\
        --webdav-username=\${WEBDAV_USER} \\
        --webdav-password=\${WEBDAV_PASS} \\
        --override-hostname=vps-backup \\
        --override-username=root || \\
      # If connect fails, try to create (Initialize)
      kopia repository create webdav \\
        --url=\${WEBDAV_URL} \\
        --webdav-username=\${WEBDAV_USER} \\
        --webdav-password=\${WEBDAV_PASS} \\
        --override-hostname=vps-backup \\
        --override-username=root;

      # Set policy (Keep 7 daily, 4 weekly)
      kopia policy set --global --keep-daily 7 --keep-weekly 4 --keep-monthly 6;

      # Create snapshot now (on start)
      echo 'üì∏ Creating statup snapshot...';
      kopia snapshot create /source;

      # Start server for maintenance/GUI (Optional) or just loop
      echo '‚úÖ Kopia Init Done. Sleeping...';
      # We use a simple loop to simulate cron-like behavior if not using server mode
      # But kopia has 'server' mode. Let's run server mode to allow remote management if needed?
      # For simplicity and stability, we just sleep. The user can 'docker exec' to run snapshots manually.
      # WAIT! User wants AUTOMATION. A simple cron loop is better.
      echo '‚è∞ Starting Cron Loop (Daily 03:00)...';
      while true; do
        current_hour=\$(date +%H%M)
        if [ \"\$current_hour\" = \"0300\" ]; then
            echo 'üì∏ Daily Snapshot...';
            kopia snapshot create /source;
            kopia maintenance run --full;
            sleep 60; # Avoid double run
        fi
        sleep 50;
      done
      "

volumes:
  kopia-cache:
  kopia-config:

networks:
  vps-net:
    external: true
