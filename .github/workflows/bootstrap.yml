name: "ðŸš€ Bootstrap: åˆå§‹åŒ–å…¨æ–° VPS"

# =============================================================================
# è§¦å‘æ–¹å¼: æ‰‹åŠ¨ (workflow_dispatch)
# åœºæ™¯: æ›´æ¢ VPS æˆ–å…¨æ–° VPS é¦–æ¬¡éƒ¨ç½²æ—¶è¿è¡Œä¸€æ¬¡
# =============================================================================
# æ‰€éœ€ GitHub Secrets (å»ºè®®å­˜æ”¾åœ¨ Environment ä¸­):
#   VPS_HOST         - VPS å…¬ç½‘ IP æˆ–åŸŸå
#   VPS_ROOT_PASS    - VPS root åˆå§‹å¯†ç  (åªåœ¨è¿™é‡Œç”¨ä¸€æ¬¡)
#   VPS_SSH_PUBKEY   - SSH å…¬é’¥å†…å®¹ (å†™å…¥ VPS, åŽç»­ deploy ç”¨å¯¹åº”ç§é’¥ç™»å½•)
#   VPS_ENV_CONTENT  - å®Œæ•´çš„ .env æ–‡ä»¶å†…å®¹ (å«æ‰€æœ‰æœåŠ¡å¯†é’¥)
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "é€‰æ‹©éƒ¨ç½²ç›®æ ‡çŽ¯å¢ƒ"
        required: true
        default: "Production"
        type: string
      vps_host_override:
        description: "ä¸´æ—¶è¦†ç›– VPS IP (å¯é€‰)"
        required: false
        type: string

env:
  DEPLOY_DIR: /opt/vps-dmz
  REPO_URL: https://github.com/${{ github.repository }}.git

jobs:
  bootstrap:
    name: åˆå§‹åŒ– VPS
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # ðŸŒŸ å…³é”®ï¼šæŒ‡å®šçŽ¯å¢ƒä»¥è¯»å–å¯¹åº”çš„ Secrets
    environment: ${{ github.event.inputs.target_env }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # â”€â”€â”€ å®‰è£… sshpass (ç”¨ root å¯†ç ç™»å½•ï¼Œä»…æ­¤ä¸€æ¬¡) â”€â”€â”€
      - name: å®‰è£… sshpass
        run: sudo apt-get install -y sshpass

      # â”€â”€â”€ ç¡®å®šç›®æ ‡ VPS IP â”€â”€â”€
      - name: è®¾ç½®ç›®æ ‡ IP
        id: vars
        run: |
          VPS_IP="${{ github.event.inputs.vps_host_override || secrets.VPS_HOST }}"
          if [ -z "$VPS_IP" ]; then
            echo "âŒ é”™è¯¯: VPS IP æœªæä¾› (inputs.vps_host_override æˆ– Secret VPS_HOST)"
            exit 1
          fi
          echo "VPS_IP=$VPS_IP" >> $GITHUB_OUTPUT
          echo "âœ… ç›®æ ‡çŽ¯å¢ƒ: ${{ github.event.inputs.target_env }}"
          echo "âœ… ç›®æ ‡ VPS: $VPS_IP"

      # â”€â”€â”€ ç¬¬ä¸€æ­¥: ä¸Šä¼  SSH å…¬é’¥ (ä½¿ç”¨ root å¯†ç ) â”€â”€â”€
      - name: ä¸Šä¼  SSH å…¬é’¥åˆ° VPS
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
          SSH_PUBKEY: ${{ secrets.VPS_SSH_PUBKEY }}
        run: |
          echo "ðŸ“¤ ä¸Šä¼  SSH å…¬é’¥..."
          sshpass -p "$ROOT_PASS" ssh \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=30 \
            root@$VPS_IP \
            "mkdir -p /root/.ssh && echo '$SSH_PUBKEY' >> /root/.ssh/authorized_keys && chmod 600 /root/.ssh/authorized_keys"
          echo "âœ… SSH å…¬é’¥å·²ä¸Šä¼ "

      # â”€â”€â”€ ç¬¬äºŒæ­¥: å…‹éš†ä»“åº“å¹¶æ³¨å…¥ .env â”€â”€â”€
      - name: éƒ¨ç½²ä»“åº“å’Œ .env åˆ° VPS
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
          ENV_CONTENT: ${{ secrets.VPS_ENV_CONTENT }}
        run: |
          echo "ðŸ“¦ å…‹éš†ä»“åº“åˆ° VPS..."
          sshpass -p "$ROOT_PASS" ssh \
            -o StrictHostKeyChecking=no \
            root@$VPS_IP \
            "
            set -e
            # å®‰è£… git (å¦‚æžœæ²¡æœ‰)
            apt-get update -qq && apt-get install -y -qq git 2>/dev/null || yum install -y git 2>/dev/null

            # å…‹éš†æˆ–æ›´æ–°ä»“åº“
            if [ -d '$DEPLOY_DIR/.git' ]; then
              echo 'ä»“åº“å·²å­˜åœ¨ï¼Œæ‰§è¡Œ pull...'
              cd $DEPLOY_DIR && git pull
            else
              echo 'å…‹éš†ä»“åº“...'
              git clone $REPO_URL $DEPLOY_DIR
            fi
            "

          echo "ðŸ“ æ³¨å…¥ .env æ–‡ä»¶..."
          # ä½¿ç”¨ printf é¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜
          sshpass -p "$ROOT_PASS" ssh \
            -o StrictHostKeyChecking=no \
            root@$VPS_IP \
            "cat > $DEPLOY_DIR/.env << 'ENVEOF'
          $ENV_CONTENT
          ENVEOF
          chmod 600 $DEPLOY_DIR/.env"

          echo "âœ… ä»“åº“å’Œ .env å·²å°±ä½"

      # â”€â”€â”€ ç¬¬ä¸‰æ­¥: è¿è¡Œ init_host.sh â”€â”€â”€
      - name: è¿è¡Œ init_host.sh (å…¨è‡ªåŠ¨åˆå§‹åŒ–)
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
          SSH_PUBKEY: ${{ secrets.VPS_SSH_PUBKEY }}
        run: |
          echo "ðŸš€ å¼€å§‹å…¨è‡ªåŠ¨åˆå§‹åŒ– (çº¦ 5-10 åˆ†é’Ÿ)..."
          sshpass -p "$ROOT_PASS" ssh \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            root@$VPS_IP \
            "
            set -e
            cd $DEPLOY_DIR

            # å°† Actions SSH å…¬é’¥ä¹Ÿæ³¨å…¥ç»™ sudor ç”¨æˆ· (init_host.sh ä¼šåˆ›å»ºæ­¤ç”¨æˆ·)
            export INJECT_SSH_PUBKEY='$SSH_PUBKEY'

            # ä»¥éžäº¤äº’æ¨¡å¼è¿è¡Œ
            export NONINTERACTIVE=true
            bash scripts/init_host.sh
            "
          echo "âœ… åˆå§‹åŒ–å®Œæˆ!"

      # â”€â”€â”€ ç¬¬å››æ­¥: éªŒè¯éƒ¨ç½² â”€â”€â”€
      - name: éªŒè¯æœåŠ¡çŠ¶æ€
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
        run: |
          echo "ðŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
          sleep 15  # ç­‰å¾…å®¹å™¨å¯åŠ¨

          sshpass -p "$ROOT_PASS" ssh \
            -o StrictHostKeyChecking=no \
            root@$VPS_IP \
            "docker ps --format 'table {{.Names}}\t{{.Status}}'"

          echo ""
          echo "=========================================="
          echo "âœ… Bootstrap å®Œæˆ!"
          echo "çŽ¯å¢ƒ: ${{ github.event.inputs.target_env }}"
          echo "=========================================="
