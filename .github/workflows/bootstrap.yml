name: "ðŸš€ Bootstrap: åˆå§‹åŒ–å…¨æ–° VPS"

# =============================================================================
# è§¦å‘æ–¹å¼: æ‰‹åŠ¨ (workflow_dispatch)
# åœºæ™¯: æ›´æ¢ VPS æˆ–å…¨æ–° VPS é¦–æ¬¡éƒ¨ç½²æ—¶è¿è¡Œä¸€æ¬¡
# =============================================================================
# æ‰€éœ€ GitHub Secrets (å»ºè®®å­˜æ”¾åœ¨ Environment ä¸­):
#   VPS_HOST         - VPS å…¬ç½‘ IP æˆ–åŸŸå
#   VPS_ROOT_PASS    - VPS root åˆå§‹å¯†ç  (åªåœ¨è¿™é‡Œç”¨ä¸€æ¬¡)
#   VPS_SSH_PUBKEY   - SSH å…¬é’¥å†…å®¹ (å†™å…¥ VPS, åŽç»­ deploy ç”¨å¯¹åº”ç§é’¥ç™»å½•)
#   VPS_ENV_CONTENT  - å®Œæ•´çš„ .env æ–‡ä»¶å†…å®¹ (å«æ‰€æœ‰æœåŠ¡å¯†é’¥)
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      target_env:
        description: "é€‰æ‹©éƒ¨ç½²ç›®æ ‡çŽ¯å¢ƒ"
        required: true
        default: "Production"
        type: string
      sync_mode:
        description: "åŒæ­¥æ¨¡å¼ (git_pull: åŽŸç”Ÿæ‹‰å–, ssh_push: SSH æŽ¨é€æ•‘æ€¥)"
        required: true
        default: "git_pull"
        type: choice
        options:
          - git_pull
          - ssh_push
      vps_host_override:
        description: "ä¸´æ—¶è¦†ç›– VPS IP (å¯é€‰)"
        required: false
        type: string

env:
  DEPLOY_DIR: /opt/vps-dmz
  REPO_URL: https://github.com/${{ github.repository }}.git

jobs:
  bootstrap:
    name: åˆå§‹åŒ– VPS
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # ðŸŒŸ å…³é”®ï¼šæŒ‡å®šçŽ¯å¢ƒä»¥è¯»å–å¯¹åº”çš„ Secrets
    environment: ${{ github.event.inputs.target_env }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      # â”€â”€â”€ åŠ è½½ SSH ç§é’¥ (ä¸ºå·²åˆå§‹åŒ–çš„æœºå™¨æä¾›å¯†é’¥è®¤è¯æ”¯æŒ) â”€â”€â”€
      - name: åŠ è½½ SSH ç§é’¥
        uses: webfactory/ssh-agent@v0.9.0
        if: ${{ secrets.VPS_SSH_PRIVATE_KEY != '' }}
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      # â”€â”€â”€ å®‰è£… sshpass (ä¸ºæ–°æœºå™¨æä¾›å¯†ç è®¤è¯æ”¯æŒ) â”€â”€â”€
      - name: å®‰è£… sshpass
        run: sudo apt-get install -y sshpass

      # â”€â”€â”€ ç¡®å®šç›®æ ‡ VPS IP ä¸Ž SSH ç«¯å£ (è‡ªé€‚åº”æŽ¢æµ‹) â”€â”€â”€
      - name: çŽ¯å¢ƒæŽ¢æµ‹
        id: vars
        run: |
          VPS_IP="${{ github.event.inputs.vps_host_override || secrets.VPS_HOST }}"
          if [ -z "$VPS_IP" ]; then
            echo "âŒ é”™è¯¯: VPS IP æœªæä¾›"
            exit 1
          fi
          
          echo "ðŸ” æ­£åœ¨æŽ¢æµ‹ SSH ç«¯å£..."
          # ä½¿ç”¨ nc è¿›è¡Œå¿«é€Ÿç«¯å£æ‰«æ (è¶…æ—¶ 3s)
          if nc -zw 3 "$VPS_IP" 22 2>/dev/null; then
            DETECTED_PORT=22
            echo "  ðŸ“ å‘çŽ°é»˜è®¤ç«¯å£: 22"
          elif nc -zw 3 "$VPS_IP" 22222 2>/dev/null; then
            DETECTED_PORT=22222
            echo "  ðŸ“ å‘çŽ°è‡ªå®šä¹‰ç«¯å£: 22222"
          else
            DETECTED_PORT=22
            echo "  âš ï¸ æœªå‘çŽ°å¼€æ”¾ç«¯å£ï¼Œå°†å›žé€€åˆ°é»˜è®¤ 22 å°è¯• (å¯èƒ½è¶…æ—¶)"
          fi

          echo "VPS_IP=$VPS_IP" >> $GITHUB_OUTPUT
          echo "SSH_PORT=$DETECTED_PORT" >> $GITHUB_OUTPUT
          echo "âœ… ç›®æ ‡ VPS: $VPS_IP (ç«¯å£: $DETECTED_PORT)"

      # â”€â”€â”€ ç¬¬ä¸€æ­¥: ä¸Šä¼  SSH å…¬é’¥ (ä½¿ç”¨ root å¯†ç æˆ–å¯†é’¥) â”€â”€â”€
      - name: ä¸Šä¼  SSH å…¬é’¥åˆ° VPS
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          SSH_PORT: ${{ steps.vars.outputs.SSH_PORT }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
          SSH_PUBKEY: ${{ secrets.VPS_SSH_PUBKEY }}
        run: |
          echo "ðŸ“¤ å°è¯•æ³¨å…¥ SSH å…¬é’¥ (Port: $SSH_PORT)..."
          # ç­–ç•¥ï¼šå¦‚æžœå¯†é’¥å·²å­˜åœ¨åˆ™ç›´æŽ¥æˆåŠŸï¼Œå¦åˆ™å°è¯•ç”¨å¯†ç æ³¨å…¥
          sshpass -p "$ROOT_PASS" ssh \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=15 \
            -o PreferredAuthentications=publickey,password \
            root@$VPS_IP \
            "mkdir -p /root/.ssh && (grep -q '$SSH_PUBKEY' /root/.ssh/authorized_keys || echo '$SSH_PUBKEY' >> /root/.ssh/authorized_keys) && chmod 600 /root/.ssh/authorized_keys"
          echo "âœ… SSH å…¬é’¥å·²ç¡®è®¤/å¹¶æ³¨å…¥"

      # â”€â”€â”€ ç¬¬äºŒæ­¥: åŒæ­¥ä»“åº“ä»£ç ä¸Ž .env â”€â”€â”€
      - name: åŒæ­¥ä»“åº“ä»£ç ä¸Ž .env
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          SSH_PORT: ${{ steps.vars.outputs.SSH_PORT }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
          ENV_CONTENT: ${{ secrets.VPS_ENV_CONTENT }}
          SYNC_MODE: ${{ github.event.inputs.sync_mode }}
        run: |
          SSH_OPTS="-p $SSH_PORT -o StrictHostKeyChecking=no -o PreferredAuthentications=publickey,password"
          if [ "$SYNC_MODE" = "ssh_push" ]; then
            echo "ðŸšš é‡‡ç”¨ SSH æŽ¨é€æ¨¡å¼ (SSH Push, Port: $SSH_PORT)..."
            sshpass -p "$ROOT_PASS" ssh $SSH_OPTS root@$VPS_IP "mkdir -p $DEPLOY_DIR"
            tar -cz --exclude='.git' . | sshpass -p "$ROOT_PASS" ssh $SSH_OPTS root@$VPS_IP "tar -xz -C $DEPLOY_DIR"
          else
            echo "ðŸ¤– é‡‡ç”¨åŽŸç”Ÿ Git æ‹‰å–æ¨¡å¼ (Git Pull, Port: $SSH_PORT)..."
            sshpass -p "$ROOT_PASS" ssh $SSH_OPTS \
              root@$VPS_IP \
              "
              set -e
              apt-get update -qq && apt-get install -y -qq git 2>/dev/null || yum install -y git 2>/dev/null

              if [ -n '${{ secrets.GH_TOKEN }}' ]; then
                TARGET_URL='https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git'
              else
                TARGET_URL='https://github.com/${{ github.repository }}.git'
              fi

              if [ -d '$DEPLOY_DIR/.git' ]; then
                cd $DEPLOY_DIR && git remote set-url origin \$TARGET_URL && git pull
              else
                git clone \$TARGET_URL $DEPLOY_DIR
              fi
              "
          fi

          echo "ðŸ“ æ³¨å…¥ .env æ–‡ä»¶..."
          sshpass -p "$ROOT_PASS" ssh $SSH_OPTS \
            root@$VPS_IP \
            "cat > $DEPLOY_DIR/.env << 'ENVEOF'
          $ENV_CONTENT
          ENVEOF
          chmod 600 $DEPLOY_DIR/.env"
          
          echo "âœ… ä»£ç å’Œ .env åŒæ­¥å®Œæˆ ($SYNC_MODE)"

      # â”€â”€â”€ ç¬¬ä¸‰æ­¥: è¿è¡Œ init_host.sh â”€â”€â”€
      - name: è¿è¡Œ init_host.sh (å…¨è‡ªåŠ¨åˆå§‹åŒ–)
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          SSH_PORT: ${{ steps.vars.outputs.SSH_PORT }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
          SSH_PUBKEY: ${{ secrets.VPS_SSH_PUBKEY }}
        run: |
          echo "ðŸš€ å¼€å§‹å…¨è‡ªåŠ¨åˆå§‹åŒ– (Port: $SSH_PORT)..."
          sshpass -p "$ROOT_PASS" ssh \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=60 \
            -o PreferredAuthentications=publickey,password \
            root@$VPS_IP \
            "
            set -e
            cd $DEPLOY_DIR
            export INJECT_SSH_PUBKEY='$SSH_PUBKEY'
            export NONINTERACTIVE=true
            bash scripts/init_host.sh
            "
          echo "âœ… åˆå§‹åŒ–å®Œæˆ!"

      # â”€â”€â”€ ç¬¬å››æ­¥: éªŒè¯éƒ¨ç½² â”€â”€â”€
      - name: éªŒè¯æœåŠ¡çŠ¶æ€
        env:
          VPS_IP: ${{ steps.vars.outputs.VPS_IP }}
          SSH_PORT: ${{ steps.vars.outputs.SSH_PORT }}
          ROOT_PASS: ${{ secrets.VPS_ROOT_PASS }}
        run: |
          echo "ðŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€ (Port: $SSH_PORT)..."
          sleep 15
          sshpass -p "$ROOT_PASS" ssh \
            -p "$SSH_PORT" \
            -o StrictHostKeyChecking=no \
            -o PreferredAuthentications=publickey,password \
            root@$VPS_IP \
            "docker ps --format 'table {{.Names}}\t{{.Status}}'"

          echo ""
          echo "=========================================="
          echo "âœ… Bootstrap å®Œæˆ!"
          echo "çŽ¯å¢ƒ: ${{ github.event.inputs.target_env }} (Detected Port: $SSH_PORT)"
          echo "=========================================="
