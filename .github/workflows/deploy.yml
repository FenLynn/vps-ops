name: "ğŸ”„ Deploy: æŒç»­éƒ¨ç½²åˆ° VPS"

# =============================================================================
# è§¦å‘æ–¹å¼:
#   - push åˆ° main åˆ†æ”¯ (è‡ªåŠ¨éƒ¨ç½²åˆ° Production ç¯å¢ƒ)
#   - workflow_dispatch (æ‰‹åŠ¨ï¼Œå¯é€‰æ‹©éƒ¨ç½²ç›®æ ‡ç¯å¢ƒ)
# åœºæ™¯: VPS å·²å®Œæˆ bootstrap åï¼Œæ¯æ¬¡ä»£ç æ›´æ–°è‡ªåŠ¨/æ‰‹åŠ¨è§¦å‘éƒ¨ç½²
# =============================================================================
# æ‰€éœ€ GitHub Secrets (å»ºè®®æŒ‰ Environment å­˜æ”¾):
#   VPS_HOST             - VPS å…¬ç½‘ IP
#   VPS_SSH_PORT         - SSH ç«¯å£ (22222)
#   VPS_USER             - SSH ç”¨æˆ·å (sudor)
#   VPS_SSH_PRIVATE_KEY  - SSH ç§é’¥å†…å®¹
#   VPS_ENV_CONTENT      - å®Œæ•´çš„ .env æ–‡ä»¶å†…å®¹
# =============================================================================

on:
  push:
    branches: [main]
    paths:
      - 'compose/**'
      - 'config/**'
      - 'scripts/**'
  workflow_dispatch:
    inputs:
      target_env:
        description: "é€‰æ‹©éƒ¨ç½²ç›®æ ‡ç¯å¢ƒ"
        required: true
        default: "Production"
        type: string

jobs:
  validate:
    name: è¯­æ³•æ ¡éªŒ
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Shell è„šæœ¬è¯­æ³•æ£€æŸ¥
        run: find . -name "*.sh" -exec bash -n {} +

      - name: Docker Compose è¯­æ³•éªŒè¯
        run: |
          cp .env.example .env
          docker compose --env-file .env -f compose/docker-compose.yml config --quiet

      - name: Python è¯­æ³•æ£€æŸ¥
        run: python3 -m py_compile config/fastapi-gateway/main.py

  deploy:
    name: éƒ¨ç½²åˆ° VPS
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # ğŸŒŸ å…³é”®ï¼šè‡ªåŠ¨ push èµ° Productionï¼Œæ‰‹åŠ¨è§¦å‘èµ°é€‰æ‹©çš„ç¯å¢ƒ
    environment: ${{ github.event.inputs.target_env || 'Production' }}

    steps:
      - uses: actions/checkout@v4

      # â”€â”€â”€ æ£€æŸ¥ Secrets é…ç½® â”€â”€â”€
      - name: æ£€æŸ¥ Secrets é…ç½®
        run: |
          MISSING_SECRETS=""
          if [ -z "${{ secrets.VPS_HOST }}" ]; then MISSING_SECRETS="$MISSING_SECRETS VPS_HOST"; fi
          if [ -z "${{ secrets.VPS_SSH_PRIVATE_KEY }}" ]; then MISSING_SECRETS="$MISSING_SECRETS VPS_SSH_PRIVATE_KEY"; fi
          if [ -z "${{ secrets.VPS_ENV_CONTENT }}" ]; then MISSING_SECRETS="$MISSING_SECRETS VPS_ENV_CONTENT"; fi
          
          if [ -n "$MISSING_SECRETS" ]; then
            echo "âŒ é”™è¯¯: ç¼ºå¤±ä»¥ä¸‹å¿…éœ€çš„ GitHub Secrets:$MISSING_SECRETS"
            echo "ğŸ’¡ è¯·æ£€æŸ¥ GitHub ä»“åº“çš„ Settings -> Environments -> ${{ github.event.inputs.target_env || 'Production' }} æ˜¯å¦åˆ›å»ºä¸”å¡«å…¥äº† Secretsã€‚"
            echo "ğŸ’¡ å¦‚æœæ²¡æœ‰ä½¿ç”¨ Environmentï¼Œè¯·ç¡®è®¤ Repository Secrets ä¸­æ˜¯å¦åŒ…å«ä¸Šè¿°å˜é‡ã€‚"
            exit 1
          fi
          echo "âœ… Secrets é…ç½®è‡ªæ£€é€šè¿‡"

      # â”€â”€â”€ é…ç½® SSH ç§é’¥ â”€â”€â”€
      - name: é…ç½® SSH ç§é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          # æ·»åŠ  VPS åˆ° known_hosts
          ssh-keyscan \
            -p "${{ vars.VPS_SSH_PORT || secrets.VPS_SSH_PORT || '22222' }}" \
            "${{ secrets.VPS_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      # â”€â”€â”€ åŒæ­¥ .env (å¦‚æœæœ‰æ›´æ–°) â”€â”€â”€
      - name: åŒæ­¥ .env åˆ° VPS
        run: |
          ssh \
            -i ~/.ssh/deploy_key \
            -p "${{ vars.VPS_SSH_PORT || secrets.VPS_SSH_PORT || '22222' }}" \
            -o StrictHostKeyChecking=no \
            "${{ vars.VPS_USER || secrets.VPS_USER || 'sudor' }}@${{ secrets.VPS_HOST }}" \
            "cat > /opt/vps-dmz/.env << 'ENVEOF'
          ${{ secrets.VPS_ENV_CONTENT }}
          ENVEOF
          chmod 600 /opt/vps-dmz/.env"

      # â”€â”€â”€ ä¸»éƒ¨ç½²é€»è¾‘ â”€â”€â”€
      - name: æ‹‰å–ä»£ç å¹¶é‡å¯æœåŠ¡
        run: |
          ssh \
            -i ~/.ssh/deploy_key \
            -p "${{ vars.VPS_SSH_PORT || secrets.VPS_SSH_PORT || '22222' }}" \
            -o StrictHostKeyChecking=no \
            -o ServerAliveInterval=30 \
            "${{ vars.VPS_USER || secrets.VPS_USER || 'sudor' }}@${{ secrets.VPS_HOST }}" \
            '
            set -e
            echo "ğŸ“¦ æ‹‰å–æœ€æ–°ä»£ç ..."
            cd /opt/vps-dmz

            # æ„å»ºå¸¦é‰´æƒæˆ–åŠ é€Ÿçš„ URL
            if [ -n "${{ secrets.GH_TOKEN }}" ]; then
              TARGET_URL="https://${{ secrets.GH_TOKEN }}@github.com/${{ github.repository }}.git"
              git remote set-url origin "$TARGET_URL"
            fi

            git pull origin main

            echo "ğŸ”„ åŒæ­¥é…ç½®æ–‡ä»¶..."
            cp -f compose/docker-compose.yml ./docker-compose.yml
            cp -f config/nginx-relay/nginx.conf ./config/nginx-relay/nginx.conf 2>/dev/null || true
            cp -rf config/fastapi-gateway/* ./config/fastapi-gateway/ 2>/dev/null || true
            cp -f scripts/*.sh ./scripts/ && chmod +x ./scripts/*.sh

            # å¦‚æœ FastAPI ä»£ç æœ‰å˜åŠ¨åˆ™é‡æ–°æ„å»º
            if git diff HEAD~1 --name-only 2>/dev/null | grep -q "config/fastapi-gateway/"; then
              echo "ğŸ—ï¸ é‡å»º FastAPI ç½‘å…³é•œåƒ..."
              docker build -t vps-ops/fastapi-gateway:latest ./config/fastapi-gateway/
            fi

            echo "ğŸš€ æ›´æ–°æœåŠ¡..."
            docker compose pull --quiet --ignore-pull-failures
            docker compose up -d --remove-orphans

            echo ""
            docker ps --format "table {{.Names}}\t{{.Status}}"
            echo "âœ… ç¯å¢ƒéƒ¨ç½²å®Œæˆ: ${{ github.event.inputs.target_env || 'Production' }}"
            '

      # â”€â”€â”€ æ¸…ç†ä¸´æ—¶æ–‡ä»¶ â”€â”€â”€
      - name: æ¸…ç† SSH å¯†é’¥
        if: always()
        run: rm -f ~/.ssh/deploy_key
