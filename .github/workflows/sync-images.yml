name: ðŸ“¦ æ‰‹åŠ¨åŒæ­¥ Docker é•œåƒè‡³ GHCR

# ä»…å…è®¸æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

jobs:
  sync-images:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. æ‰¹é‡ä¸­è½¬å¹¶æŽ¨é€é•œåƒ
        run: |
          # å‚è€ƒ acme è®¾è®¡ï¼šåœ¨ step å†…å®šä¹‰å˜é‡å¹¶è½¬å°å†™
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          echo "ðŸš€ æ­£åœ¨æ¬è¿é•œåƒåˆ° ghcr.io/${OWNER}..."
          
          # å®šä¹‰é•œåƒæ˜ å°„åˆ—è¡¨: "æºé•œåƒ|ç›®æ ‡å…¨ç§°"
          IMAGES=(
            "kopia/kopia:latest|ghcr.io/${OWNER}/kopia:latest"
            "pan93412/unblock-netease-music-enhanced:latest|ghcr.io/${OWNER}/unblock-netease-music-enhanced:latest"
            "fredliang/derper:latest|ghcr.io/${OWNER}/derper:latest"
          )

          for item in "${IMAGES[@]}"; do
            SRC="${item%%|*}"
            DST="${item##*|}"
            echo "  - æ­£åœ¨æ¬è¿: ${SRC} -> ${DST}"
            docker pull "${SRC}"
            docker tag "${SRC}" "${DST}"
            docker push "${DST}"
          done

      - name: 3. è‡ªåŠ¨å°†å®¹å™¨é•œåƒè®¾ä¸ºå…¬å¼€ (Public)
        env:
          # æ­¤æ“ä½œå¿…é¡»ä½¿ç”¨å…·æœ‰ admin:packages æƒé™çš„ä¸ªäººè®¿é—®ä»¤ç‰Œ (PAT)
          # å¦‚æžœ secrets.GH_TOKEN æœªè®¾ç½®ï¼Œä»¥ä¸‹æ­¥éª¤ä¼šæŠ¥é”™
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ -z "$GH_TOKEN" ]; then
            echo "âŒ é”™è¯¯: æœªå‘çŽ° secrets.GH_TOKENã€‚è¯·ç¡®ä¿åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ äº†æ­¤ Secret (éœ€è¦ admin:packages æƒé™)ã€‚"
            exit 1
          fi

          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          for pkg in kopia unblock-netease-music-enhanced derper; do
            echo "ðŸŒ æ­£åœ¨å°† ${pkg} è®¾ä¸º Public..."
            
            # å°è¯•å¤šç§è·¯å¾„ (å…¼å®¹ä¸ªäººå’Œç»„ç»‡è´¦å·)
            # ä½¿ç”¨ -H å¤´éƒ¨å£°æ˜Ž API ç‰ˆæœ¬
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/user/packages/container/${pkg}/manage_visibility" \
              -f visibility='public' || \
            gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/${OWNER}/packages/container/${pkg}/manage_visibility" \
              -f visibility='public' || \
            echo "  âš ï¸ ${pkg} è‡ªåŠ¨å…¬å¼€å¤±è´¥ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºè¯¥é•œåƒå°šæœªå®Œæˆåˆ›å»ºï¼Œæˆ–æ‚¨çš„ Token æ²¡æœ‰è¯¥åŒ…çš„ç®¡ç†æƒé™ã€‚"
          done
          
          echo "ðŸ’¡ å¦‚æžœè‡ªåŠ¨è®¾ç½®ä¾ç„¶å¤±è´¥ï¼Œè¯·åŠ¡å¿…æ‰‹åŠ¨æ‰§è¡Œï¼šGitHub -> Packages -> è¿›å…¥åŒ… -> Package Settings -> Change Visibility -> Public"
