name: ðŸ“¦ æ‰‹åŠ¨åŒæ­¥ Docker é•œåƒè‡³ GHCR

# ä»…å…è®¸æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1' # æ¯å‘¨ä¸€è‡ªåŠ¨å‘ä½ çš„ GHCR å…œåº•åŒæ­¥æ›´æ–°ä¸€æ¬¡

jobs:
  sync-images:
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: read
      packages: write

    steps:
      - name: 1. ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 2. æ‰¹é‡ä¸­è½¬å¹¶æŽ¨é€é•œåƒ (å·²å­˜åœ¨åˆ™è·³è¿‡)
        run: |
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          echo "ðŸš€ æ­£åœ¨æ¬è¿é•œåƒåˆ° ghcr.io/${OWNER}..."

          # æ ¼å¼: "æºé•œåƒ|ç›®æ ‡é•œåƒ(ä¸å« ghcr.io/${OWNER}/ å‰ç¼€)"
          # æœ‰ç‰ˆæœ¬è¦æ±‚çš„é•œåƒè¯·é”å®šå…·ä½“ç‰ˆæœ¬å·ï¼Œlatest é•œåƒæ¯æ¬¡ä¹Ÿä¼šæ£€æŸ¥
          IMAGES=(
            "fogforest/yesplaymusic:latest|yesplaymusic:latest"
            "cloudflare/cloudflared:latest|cloudflared:latest"
            "neilpang/acme.sh:latest|acme.sh:latest"
            "louislam/uptime-kuma:1|uptime-kuma:1"
            "amir20/dozzle:latest|dozzle:latest"
            "nginx:alpine|nginx:alpine"
            "calciumion/new-api:latest|new-api:latest"
            "binaryify/netease_cloud_music_api:latest|netease_cloud_music_api:latest"
          )

          for item in "${IMAGES[@]}"; do
            SRC="${item%%|*}"
            DST_SHORT="${item##*|}"
            DST="ghcr.io/${OWNER}/${DST_SHORT}"

            echo ""
            echo "â”€â”€ æ£€æŸ¥: ${DST}"

            # ä½¿ç”¨ manifest inspect æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨äºŽ GHCR
            # --insecure é˜²æ­¢ç½‘ç»œé—®é¢˜è¯¯æŠ¥ï¼Œå¤±è´¥åˆ™ç»§ç»­æ‹‰å–
            if docker manifest inspect "${DST}" > /dev/null 2>&1; then
              echo "  âœ… å·²å­˜åœ¨ï¼Œè·³è¿‡: ${DST}"
              continue
            fi

            echo "  ðŸ”„ ä¸å­˜åœ¨ï¼Œå¼€å§‹æ¬è¿: ${SRC} -> ${DST}"
            docker pull "${SRC}"
            docker tag "${SRC}" "${DST}"
            docker push "${DST}"
            echo "  âœ… æŽ¨é€å®Œæˆ: ${DST}"
          done

          echo ""
          echo "ðŸŽ‰ æ‰€æœ‰é•œåƒåŒæ­¥å®Œæ¯•ï¼"

      - name: 3. è‡ªåŠ¨å°†å®¹å™¨é•œåƒè®¾ä¸ºå…¬å¼€ (Public)
        env:
          # æ³¨æ„: ä¸èƒ½ä½¿ç”¨ GH_TOKEN ä½œä¸ºå˜é‡åï¼Œå®ƒæ˜¯ gh CLI çš„ä¿ç•™å˜é‡ä¼šè¢«å†…ç½® GITHUB_TOKEN è¦†ç›–
          GHCR_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          if [ -z "$GHCR_TOKEN" ]; then
            echo "âš ï¸  è­¦å‘Š: æœªå‘çŽ° secrets.GH_TOKENï¼Œè·³è¿‡è‡ªåŠ¨å…¬å¼€æ­¥éª¤ã€‚"
            echo "ðŸ’¡ è¯·æ‰‹åŠ¨æ‰§è¡Œï¼šGitHub -> Packages -> è¿›å…¥åŒ… -> Package Settings -> Change Visibility -> Public"
            exit 0
          fi

          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')

          # æ‰€æœ‰éœ€è¦è®¾ä¸ºå…¬å¼€çš„åŒ…ååˆ—è¡¨
          PACKAGES=(
            yesplaymusic
            cloudflared
            acme.sh
            uptime-kuma
            dozzle
            nginx
            new-api
            netease_cloud_music_api
          )

          for pkg in "${PACKAGES[@]}"; do
            echo "ðŸŒ æ­£åœ¨å°† ${pkg} è®¾ä¸º Public..."
            GH_TOKEN="$GHCR_TOKEN" gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/user/packages/container/${pkg}/manage_visibility" \
              -f visibility='public' || \
            GH_TOKEN="$GHCR_TOKEN" gh api \
              --method PATCH \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "/orgs/${OWNER}/packages/container/${pkg}/manage_visibility" \
              -f visibility='public' || \
            echo "  âš ï¸ ${pkg} è‡ªåŠ¨å…¬å¼€å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ“ä½œ: GitHub -> Packages -> è¿›å…¥åŒ… -> Package Settings -> Change Visibility -> Public"
          done

          echo "ðŸ’¡ å¦‚æžœè‡ªåŠ¨è®¾ç½®ä¾ç„¶å¤±è´¥ï¼Œè¯·åŠ¡å¿…æ‰‹åŠ¨æ‰§è¡Œï¼šGitHub -> Packages -> è¿›å…¥åŒ… -> Package Settings -> Change Visibility -> Public"
