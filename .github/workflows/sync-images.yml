name: Sync Docker Hub Images to GHCR

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1' # æ¯å‘¨ä¸€è‡ªåŠ¨å‘ä½ çš„ GHCR å…œåº•åŒæ­¥æ›´æ–°ä¸€æ¬¡

env:
  REGISTRY: ghcr.io
  # GitHub å¼ºåˆ¶è¦æ±‚ä»“åº“ namespace ä¸ºå…¨å°å†™
  OWNER: fenlynn

jobs:
  sync-to-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: 1. Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 2. Pull, Retag and Push Images
        run: |
          # æ³¨æ„ï¼šä»¥ä¸‹åˆ—è¡¨å¿…é¡»åªåŒ…å«ä»å¤–ç•Œ Docker Hub æŠ“å–çš„â€œä»–æºâ€é•œåƒï¼
          # å¯¹äºæœ¬æ¥å°±åœ¨ä½  GitHub è‡ªåŠ¨æ„å»ºçš„ï¼ˆå¦‚ derper, kopia, unblock-neteaseï¼‰ï¼Œä¸è¦æ”¾å…¥æ­¤è¡¨ï¼
          IMAGES=(
            "qier222/yesplaymusic:latest|yesplaymusic:latest"
            "cloudflare/cloudflared:latest|cloudflared:latest"
            "neilpang/acme.sh:latest|acme.sh:latest"
            "louislam/uptime-kuma:1|uptime-kuma:1"
            "louislam/dockge:1|dockge:1"
            "nginx:alpine|nginx:alpine"
            "calciumion/new-api:latest|new-api:latest"
            "binaryify/netease_cloud_music_api:latest|netease_cloud_music_api:latest"
          )
          
          for item in "${IMAGES[@]}"; do
            SOURCE_IMG="${item%%|*}"
            TARGET_IMG_NAME="${item##*|}"
            TARGET_IMG="${{ env.REGISTRY }}/${{ env.OWNER }}/$TARGET_IMG_NAME"
            
            # é˜²å¾¡æ€§è¿‡æ»¤ï¼šå¦‚æœé…ç½®é¡¹æœ¬èº«å°±æ˜¯ ghcr.io å¼€å¤´çš„å®˜æ–¹ä»“æ¥æºï¼Œåˆ™ç›´æ¥è·³è¿‡ï¼é˜²æ­¢å¥—å¨ƒ
            if [[ "$SOURCE_IMG" == ghcr.io/* ]]; then
              echo "â­ï¸ è·³è¿‡åŸç”Ÿ GHCR é•œåƒ: $SOURCE_IMG"
              continue
            fi
            
            echo "ğŸš€ å¼€å§‹æ‹‰å–: $SOURCE_IMG"
            docker pull "$SOURCE_IMG"
            
            echo "ğŸ·ï¸ æ‰“ä¸Šæ–°æ ‡ç­¾: $TARGET_IMG"
            docker tag "$SOURCE_IMG" "$TARGET_IMG"
            
            echo "ğŸ“¤ æ¨é€åˆ°ç§æœ‰/å…¬æœ‰ GHCR..."
            docker push "$TARGET_IMG"
            echo "----------------------------------------"
          done

      - name: 3. Trigger VPS to Pull and Update
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "1. è§¦å‘ VPS ä»åˆšåˆšåŒæ­¥å¥½çš„ GHCR æ‹‰å–å…¨é‡æ›´æ–°..."
            cd /opt/vps-dmz/compose
            docker-compose pull
            
            echo "2. é‡å¯æ”¹å˜çš„å®¹å™¨å¹¶ç§»é™¤å­¤å„¿..."
            docker-compose up -d --remove-orphans
            
            echo "3. æ¸…ç† VPS æ—§é•œåƒ..."
            docker image prune -f
            
            echo "ğŸ‰ GHCR çš„è½¬å­˜ä¸æ‹‰å–æ›´æ–°å…¨é¢å®Œæˆï¼"
