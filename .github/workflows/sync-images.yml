name: Sync Docker Hub Images to GHCR

on:
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * 1' # æ¯å‘¨ä¸€è‡ªåŠ¨å‘ä½ çš„ GHCR å…œåº•åŒæ­¥æ›´æ–°ä¸€æ¬¡

env:
  REGISTRY: ghcr.io
  # GitHub å¼ºåˆ¶è¦æ±‚ä»“åº“ namespace ä¸ºå…¨å°å†™
  OWNER: fenlynn

jobs:
  sync-to-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: 1. Log in to the GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 2. Pull, Retag and Push Images
        run: |
          # æ ¼å¼: æºé•œåƒåç§°|æ¨é€åˆ° GHCR åçš„æœ«å°¾åç§° (ä¸è¦å¸¦ fenlynn)
          IMAGES=(
            "qier222/yesplaymusic:latest|yesplaymusic:latest"
            "cloudflare/cloudflared:latest|cloudflared:latest"
            "neilpang/acme.sh:latest|acme.sh:latest"
            "louislam/uptime-kuma:1|uptime-kuma:1"
            "louislam/dockge:1|dockge:1"
            "nginx:alpine|nginx:alpine"
            "calciumion/new-api:latest|new-api:latest"
            "binaryify/netease_cloud_music_api:latest|netease_cloud_music_api:latest"
            # ä¸‹é¢è¿™äº›å·²ç»æ˜¯ ghcr æºçš„ï¼Œæ­£å¸¸ä¸ç”¨è½¬ï¼Œä½†é˜²æ­¢æºä½œè€…åˆ åº“ä¹Ÿå¯åŠ å…¥å¤‡ä»½ï¼š
            # "ghcr.io/ajnart/homarr:latest|homarr:latest"
          )
          
          for item in "${IMAGES[@]}"; do
            SOURCE_IMG="${item%%|*}"
            TARGET_IMG_NAME="${item##*|}"
            TARGET_IMG="${{ env.REGISTRY }}/${{ env.OWNER }}/$TARGET_IMG_NAME"
            
            echo "ğŸš€ å¼€å§‹æ‹‰å–: $SOURCE_IMG"
            docker pull "$SOURCE_IMG"
            
            echo "ğŸ·ï¸ æ‰“ä¸Šæ–°æ ‡ç­¾: $TARGET_IMG"
            docker tag "$SOURCE_IMG" "$TARGET_IMG"
            
            echo "ğŸ“¤ æ¨é€åˆ°ç§æœ‰/å…¬æœ‰ GHCR..."
            docker push "$TARGET_IMG"
            echo "----------------------------------------"
          done

      - name: 3. Trigger VPS to Pull and Update
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "1. è§¦å‘ VPS ä»åˆšåˆšåŒæ­¥å¥½çš„ GHCR æ‹‰å–å…¨é‡æ›´æ–°..."
            cd /opt/vps-dmz/compose
            docker-compose pull
            
            echo "2. é‡å¯æ”¹å˜çš„å®¹å™¨å¹¶ç§»é™¤å­¤å„¿..."
            docker-compose up -d --remove-orphans
            
            echo "3. æ¸…ç† VPS æ—§é•œåƒ..."
            docker image prune -f
            
            echo "ğŸ‰ GHCR çš„è½¬å­˜ä¸æ‹‰å–æ›´æ–°å…¨é¢å®Œæˆï¼"
