name: Sync Docker Images to VPS (Offline Mode)

on:
  workflow_dispatch:
    inputs:
      force_clean:
        description: 'å®Œæˆåæ˜¯å¦æ¸…ç† VPS ä¸Šçš„æ—§æ‚¬ç©ºé•œåƒ (true/false)'
        required: true
        default: 'true'

jobs:
  sync-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Setup Docker Environment
        run: |
          # ç¡®ä¿ Github æœºå™¨ä¸Šçš„ Docker ç©ºé—´å……è¶³
          docker system prune -af

      - name: 2. Pull Required Images (Define Tags Here)
        run: |
          # ğŸ’¡ åœ¨è¿™é‡Œå®šä¹‰ä½ è¦æ‹‰å–çš„é•œåƒæ¸…å•ä¸å…¶ Tagï¼
          # ä¿®æ”¹è¿™é‡Œçš„ç‰ˆæœ¬å·å³å¯å†³å®šé˜¿é‡Œäº‘è·‘çš„æ˜¯ä»€ä¹ˆç‰ˆæœ¬
          
          IMAGES=(
            "qier222/yesplaymusic:latest"
            "cloudflare/cloudflared:latest"
            "neilpang/acme.sh:latest"
            "louislam/uptime-kuma:1"
            "louislam/dockge:1"
            "nginx:alpine"
            "calciumion/new-api:latest"
            "ghcr.io/fenlynn/unblock-netease-music-enhanced:latest"
            "binaryify/netease_cloud_music_api:latest"
            "ghcr.io/fenlynn/derper:latest"
            "ghcr.io/ajnart/homarr:latest"
            "ghcr.io/fenlynn/kopia:latest"
          )

          echo "å¼€å§‹æ‹‰å–é•œåƒåˆ—è¡¨..."
          for img in "${IMAGES[@]}"; do
            echo "Pulling $img..."
            docker pull $img
          done

          echo "å°†æ‰€æœ‰é•œåƒæ‰“åŒ…æˆå•ä¸ªå‹ç¼©å½’æ¡£..."
          # docker save æ”¯æŒä¼ å…¥å¤šä¸ªé•œåƒåç§°ï¼Œä¸€æ¬¡æ€§æ‰“åŒ…
          docker save "${IMAGES[@]}" | gzip > offline-images.tar.gz
          echo "æ‰“åŒ…å®Œæˆï¼å¤§å°ï¼š"
          ls -lh offline-images.tar.gz

      - name: 3. Transfer Archive to VPS via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          source: "offline-images.tar.gz"
          target: "/opt/vps-dmz/temp/"
          overwrite: true

      - name: 4. Unpack, Start and Clean on VPS
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: root
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            echo "1. å¯¼å…¥ç¦»çº¿é•œåƒ..."
            docker load < /opt/vps-dmz/temp/offline-images.tar.gz
            
            echo "2. ä½¿ç”¨æ–°é•œåƒæ‹‰èµ·å®¹å™¨å¹¶ç§»é™¤å­¤å„¿..."
            cd /opt/vps-dmz/compose
            docker-compose up -d --remove-orphans
            
            echo "3. æ¸…ç†ä¸­è½¬å¤§æ–‡ä»¶..."
            rm -f /opt/vps-dmz/temp/offline-images.tar.gz
            
            if [ "${{ github.event.inputs.force_clean }}" = "true" ]; then
              echo "4. å¼ºåˆ¶æ¸…ç†æ‚¬ç©ºçš„æ—§ç‰ˆæœ¬åƒåœ¾é•œåƒï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´..."
              docker image prune -f
            fi
            
            echo "ğŸ‰ å…¨é‡ç¦»çº¿åŒæ­¥ä¸æ»šåŠ¨æ›´æ–°åœ†æ»¡å®Œæˆï¼"
